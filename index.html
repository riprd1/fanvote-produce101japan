<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>投票（11人）</title>
  <style>
    :root{
      --bd:#e6e6e6;
      --bg:#fafafa;
      --txt:#111;
      --sub:#666;
      --pill:#f2f2f2;
    }
    body{
      font-family: system-ui, -apple-system, sans-serif;
      margin: 16px;
      color: var(--txt);
      background: #fff;
    }
    h1{font-size:18px;margin:0 0 10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .pill{background:var(--pill);padding:6px 10px;border-radius:999px;font-size:12px}
    .btn{
      padding:10px 12px;border:1px solid var(--bd);
      border-radius:12px;background:#fff;font-weight:800;cursor:pointer;
    }
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type="text"]{
      padding:10px 12px;border:1px solid var(--bd);
      border-radius:12px;min-width:180px;flex:1;
    }

    /* ===== 上：選択11人 ===== */
    .selectedWrap{
      border:1px solid var(--bd);
      border-radius:16px;
      padding:12px;
      background: var(--bg);
    }
    .selectedTitle{
      font-weight:900;
      font-size:13px;
      margin:0 0 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .selectedCount{font-weight:900}
    .slots{
      display:flex;
      gap:10px;
      overflow-x:auto;
      padding-bottom:6px;
      -webkit-overflow-scrolling: touch;
    }
    .slot{
      flex:0 0 auto;
      width:54px;height:54px;
      border-radius:16px;
      border:2px dashed #cfcfcf;
      background:#fff;
      display:grid;
      place-items:center;
      color:#9a9a9a;
      font-weight:900;
      position:relative;
    }
    .slot.filled{
      border-style:solid;
      border-color:#dcdcdc;
      padding:0;
      overflow:hidden;
    }
    .slot img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#f2f2f2;
    }
    .slot .x{
      position:absolute;
      top:-8px; right:-8px;
      width:24px;height:24px;
      border-radius:999px;
      background:#111;
      color:#fff;
      display:grid;
      place-items:center;
      font-size:14px;
      cursor:pointer;
      border:2px solid #fff;
    }

    /* ===== 中：一覧ラベル ===== */
    .listHeader{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .listHeader h2{
      margin:0;
      font-size:14px;
      font-weight:900;
    }
    .sub{color:var(--sub);font-size:12px}

    /* ===== 下：2列グリッド（スクショ寄せ） ===== */
    .grid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:14px;
    }
    .card{
      position: relative;
      border:1px solid var(--bd);
      border-radius:18px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column; /* 縦並び */
      gap:10px;
    }
    .avatar{
      width:100%;
      aspect-ratio: 4 / 5;  /* 縦長 */
      height:auto;
      border-radius:16px;
      overflow:hidden;
      background:#f2f2f2;
      position:relative;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    /* profileボタン（写真右上） */
    .profileBtn{
      position:absolute;
      top:10px;
      right:10px;
      padding:6px 12px;
      border-radius:999px;
      border:2px solid rgba(100,150,255,.35);
      background:rgba(255,255,255,.85);
      color:#2f6fe8;
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      backdrop-filter: blur(6px);
    }

    .info{min-width:0;text-align:center}
    .name{
      font-weight:900;
      font-size:14px;
      line-height:1.25;
      word-break:break-word;
    }
    .meta{font-size:12px;color:var(--sub);margin-top:4px}

    /* +/✓ を使わない */
    .pick{display:none !important;}
    .picked{
      outline:2px solid rgba(0,0,0,.08);
    }

    /* 画面が狭い時は1列 */
    @media (max-width: 340px){
      .grid{grid-template-columns: 1fr;}
    }
  </style>
</head>

<body>
  <h1>投票（1回で11人選択）</h1>

  <div class="row" style="margin: 8px 0 12px;">
    <button id="toggleBtn" class="btn">練習生候補を表示</button>
    <input id="search" type="text" placeholder="Search（名前/英字/ID）">
    <span class="pill" id="modePill">表示：練習生</span>
  </div>

  <div class="selectedWrap">
    <div class="selectedTitle">
      <span>選択中</span>
      <span class="selectedCount"><span id="count">0</span>/11</span>
    </div>
    <div class="slots" id="slots"></div>

    <div class="row" style="margin-top:10px;">
      <button id="clearBtn" class="btn">リセット</button>
      <button id="undoBtn" class="btn">1人戻す</button>
      <button id="voteBtn" class="btn primary" disabled>11人選んで投票</button>
    </div>
    <div class="sub" style="margin-top:6px;">
      ※上の顔をタップで削除できます
    </div>
  </div>

  <div class="listHeader">
    <h2>一覧（押して追加）</h2>
    <span class="sub" id="resultCount"></span>
  </div>

  <div class="grid" id="grid"></div>

<script>
/* ====== 練習生データ（あなたのまま） ====== */
const traineesOnly = [/* 省略なし：あなたが貼った内容そのまま */ 
  {name:"アダム・ナガイ(ADAM)", img:"https://i.imgur.com/6QGzvRx.png", id:"adamnagai"},
  {name:"中丸 晏寿(AJU)", img:"https://i.imgur.com/KiZCKos.png", id:"nakamaruaju"},
  {name:"オム・スアンカワーテン(AOM)", img:"https://i.imgur.com/dDIFJSc.png", id:"aomsuungkavathin"},
  {name:"アーチャー・ウイ(ARCHER)", img:"https://i.imgur.com/5iIerqN.png", id:"archeruy"},
  {name:"篠ヶ谷 歩夢(S.AYUMU)", img:"https://i.imgur.com/YJAdh8q.png", id:"shinogayaayumu"},
  {name:"小林 千悟(CHISATO)", img:"https://i.imgur.com/Iu0hNBO.png", id:"kobayashichisato"},
  {name:"加藤 大樹 (K.DAIKI)", img:"https://i.imgur.com/4fRk2EB.png", id:"katodaiki"},
  {name:"カク・ドンミン(DONGMIN)", img:"https://i.imgur.com/xZSQqMh.png", id:"kwakdongmin"},
  {name:"末川 瑛太(EITA)", img:"https://i.imgur.com/alEjKCP.png", id:"suekawaeita"},
  {name:"保里 瑛都(H.EITO)", img:"https://i.imgur.com/IAhs4ZA.png", id:"horieito"},
  {name:"金田 栄都(K.EITO)", img:"https://i.imgur.com/tF7i1du.png", id:"kanedaeito"},
  {name:"櫻井 楓真(FUMA)", img:"https://i.imgur.com/WIWI8Sx.png", id:"sakuraifuma"},
  {name:"小笠原ジュゼッペ慧(GIUSEPPE)", img:"https://i.imgur.com/2oKn3Ma.jpeg", id:"ogasawaragiuseppekei"},
  {name:"倉橋 吾槙(GOTEN)", img:"https://i.imgur.com/hlEjYqR.png", id:"kurahashigoten"},
  {name:"堀尾 聖(HIJIRI)", img:"https://i.imgur.com/5Qb5dRJ.png", id:"horiohijiri"},
  {name:"瑞慶覧 太都(HIROTO)", img:"https://i.imgur.com/siOPGIr.png", id:"zukeranhiroto"},
  {name:"ユ・ヒョンスン(HYEONSEUNG)", img:"https://i.imgur.com/lY3lXLj.png", id:"yoohyeonseung"},
  {name:"岡田 彪吾(HYUGO)", img:"https://i.imgur.com/zalwc1W.png", id:"okadahyugo"},
  {name:"柳谷 伊冴(ISSA)", img:"https://i.imgur.com/gboCNWu.png", id:"yanagiyaissa"},
  {name:"ユン・ジェヨン(JAEYONG)", img:"https://i.imgur.com/1yCImxd.png", id:"yoonjaeyong"},
  {name:"ジュアン・ジェイ(JAY)", img:"https://i.imgur.com/41jKNZX.png", id:"chuangjay"},
  {name:"丸尾 尋一郎(JINICHIRO)", img:"https://i.imgur.com/83azYjx.png", id:"maruojinichiro"},
  {name:"河邊 晟(JOE)", img:"https://i.imgur.com/DqUS1o6.png", id:"kawabejoe"},
  {name:"シン・ジョンウク(JUNGUK)", img:"https://i.imgur.com/6cwEusK.jpeg", id:"shinjunguk"},
  {name:"金安 純正(JUNSEI)", img:"https://i.imgur.com/juPhMDR.png", id:"kaneyasujunsei"},
  {name:"宇野 海夢(KAIMU)", img:"https://i.imgur.com/QVliSyD.png", id:"unokaimu"},
  {name:"多比 奏聖(KANADE)", img:"https://i.imgur.com/rdSJ6QX.png", id:"tabikanade"},
  {name:"横山 奏夢(KANAME)", img:"https://i.imgur.com/0brlEw8.png", id:"yokoyamakaname"},
  {name:"関 敬次郎(KEIJIRO)", img:"https://i.imgur.com/PHlkDUt.png", id:"sekikeijiro"},
  {name:"髙松 敬祐(KEISUKE)", img:"https://i.imgur.com/bs4vfiF.png", id:"takamatsukeisuke"},
  {name:"小野 慶人(KEITO)", img:"https://i.imgur.com/glfmRJE.png", id:"onokeito"},
  {name:"西山 賢人(KENTO)", img:"https://i.imgur.com/izEXoBY.png", id:"nishiyamakento"},
  {name:"河合 晃誠(KOSEI)", img:"https://i.imgur.com/E30eGfr.png", id:"kawaikosei"},
  {name:"照井 康祐(KOSUKE)", img:"https://i.imgur.com/oDkwdFn.png", id:"teruikosuke"},
  {name:"浅香 孝太郎(KOTARO)", img:"https://i.imgur.com/7eJxl8o.png", id:"asakakotaro"},
  {name:"髙谷 京平(KYOHEI)", img:"https://i.imgur.com/CLU1cPO.png", id:"takayakyohei"},
  {name:"田中 蒔(MAKI)", img:"https://i.imgur.com/No6Nybr.png", id:"tanakamaki"},
  {name:"山根 武蔵(MUSASHI)", img:"https://i.imgur.com/Ou2XuDa.png", id:"yamanemusashi"},
  {name:"土田 央修(OSUKE)", img:"https://i.imgur.com/Xs0WjIn.png", id:"tsuchidaosuke"},
  {name:"堀野 蓮(H.REN)", img:"https://i.imgur.com/FQEx0JM.png", id:"horinoren"},
  {name:"小清水 蓮(KO.REN)", img:"https://i.imgur.com/S8Ij9OZ.png", id:"koshimizuren"},
  {name:"チェン・リッキー(RICKEY)", img:"https://i.imgur.com/DnnZVAT.png", id:"chenrickey"},
  {name:"神元 理丘(RIKU)", img:"https://i.imgur.com/jwJ9CLd.png", id:"kamimotoriku"},
  {name:"鳩場 陸人(H.RIKUTO)", img:"https://i.imgur.com/JdCFbCb.png", id:"hatobarikuto"},
  {name:"今江 陸斗(I.RIKUTO)", img:"https://i.imgur.com/jiZZwJu.png", id:"imaerikuto"},
  {name:"甲斐 陸也(RIKUYA)", img:"https://i.imgur.com/lfiqB2f.png", id:"kairikuya"},
  {name:"大瀬 凜和(RINTO)", img:"https://i.imgur.com/OT0UHId.png", id:"ohserinto"},
  {name:"上野 琉偉(U.RUI)", img:"https://i.imgur.com/36XqMd9.png", id:"uenorui"},
  {name:"飯塚 亮賀(RYOGA)", img:"https://i.imgur.com/ExbaI6W.png", id:"iizukaryoga"},
  {name:"石田 亮太(RYOTA)", img:"https://i.imgur.com/Ctw95jF.png", id:"ishidaryota"},
  {name:"岡戸 竜芽(RYUGA)", img:"https://i.imgur.com/gyPHKjY.png", id:"okadoryuga"},
  {name:"杉山 竜司(RYUJI)", img:"https://i.imgur.com/NeB980M.png", id:"sugiyamaryuji"},
  {name:"香月 誠太(SEITA)", img:"https://i.imgur.com/def6F6u.png", id:"katsukiseita"},
  {name:"澤井 星名(SENA)", img:"https://i.imgur.com/Dpzzr9K.png", id:"sawaisena"},
  {name:"オ・シンヘン(SHINHAENG)", img:"https://i.imgur.com/LH673dA.png", id:"ohshinhaeng"},
  {name:"岩城 慎二(SHINJI)", img:"https://i.imgur.com/h5rDvjC.png", id:"iwakishinji"},
  {name:"宮崎 真佑(SHINSUKE)", img:"https://i.imgur.com/xJuj9wW.png", id:"miyazakishinsuke"},
  {name:"西﨑 柊(N.SHU)", img:"https://i.imgur.com/OZrHFUX.png", id:"nishizakishu"},
  {name:"山下 柊(Y.SHU)", img:"https://i.imgur.com/642IX8o.png", id:"yamashitashu"},
  {name:"パク・シヨン(SIYOUNG)", img:"https://i.imgur.com/wSokxJh.png", id:"parksiyoung"},
  {name:"佐藤 碧空 (S.SORA)", img:"https://i.imgur.com/yF4WJJB.png", id:"satosora"},
  {name:"東野 蒼汰(SOTA)", img:"https://i.imgur.com/GvLpwfo.png", id:"tonosota"},
  {name:"藤牧 大雅(F.TAIGA)", img:"https://i.imgur.com/4G2hBRy.png", id:"fujimakitaiga"},
  {name:"松田 太雅(M.TAIGA)", img:"https://i.imgur.com/tICsJFs.png", id:"matsudataiga"},
  {name:"金倉 拓未(TAKUMI)", img:"https://i.imgur.com/O3gluG7.png", id:"kanakuratakumi"},
  {name:"熊部 拓斗(K.TAKUTO)", img:"https://i.imgur.com/NaQURc7.png", id:"kumabetakuto"},
  {name:"宮里 拓利(M.TAKUTO)", img:"https://i.imgur.com/5B8NMyF.png", id:"miyazatotakuto"},
  {name:"南平 達矢(TATSUYA)", img:"https://i.imgur.com/jHnmGTs.png", id:"minamihiratatsuya"},
  {name:"森井 輝(TERU)", img:"https://i.imgur.com/SAo1Rs4.png", id:"moriiteru"},
  {name:"北林 天虎(TETORA)", img:"https://i.imgur.com/2gCwqHF.png", id:"kitabayashitetora"},
  {name:"藤芳 辰弥(TOKIYA)", img:"https://i.imgur.com/9prpjvI.png", id:"fujiyoshitokiya"},
  {name:"増田 倫希(TOMOKI)", img:"https://i.imgur.com/4JSh3HD.png", id:"masudatomoki"},
  {name:"濱田 永遠(TOWA)", img:"https://i.imgur.com/Yap9beM.png", id:"hamadatowa"},
  {name:"アギナルド・トリスタン・ジェームス(TRISTAN)", img:"https://i.imgur.com/wyeHbRo.png", id:"aguinaldotristanjames"},
  {name:"リー・ウェイゼ(WEIZE)", img:"https://i.imgur.com/XNeHaaX.png", id:"liweize"},
  {name:"ヨハン・エマニュエル(YOHAN)", img:"https://i.imgur.com/RTVMTCA.png", id:"yohanemmanuel"},
  {name:"矢田 佳暉(YOSHIKI)", img:"https://i.imgur.com/MZbSVDq.png", id:"yadayoshiki"},
  {name:"後藤 結(YUKI)", img:"https://i.imgur.com/GZTdD57.png", id:"gotoyuki"},
  {name:"岡田 侑磨(YUMA)", img:"https://i.imgur.com/3hhNQLj.png", id:"okadayuma"},
  {name:"安部 結蘭(YURA)", img:"https://i.imgur.com/pbC301p.png", id:"abeyura"},
  {name:"大林 悠成(O.YUSEI)", img:"https://i.imgur.com/tp1fKqI.png", id:"obayashiyusei"},
  {name:"佐野 由征(S.YUSEI)", img:"https://i.imgur.com/fDql5Tu.png", id:"sanoyusei"},
  {name:"板倉 悠太(YUTA)", img:"https://i.imgur.com/j6IlxeD.png", id:"itakurayuta"}
];

const candidates = [
  {name:"本荘 晃(AKIRA)", img:"https://i.imgur.com/p976l8j.jpeg", id:"honjoakira"},
  {name:"児島 歩夢(K.AYUMU)", img:"https://i.imgur.com/1jtcgbB.png", id:"kojimaayumu"},
  {name:"市川 大輝(I.DAIKI)", img:"https://i.imgur.com/72FqxLz.png", id:"ichikawadaiki"},
  {name:"川村 珀斗(HAKUTO)", img:"https://i.imgur.com/ua7RMig.png", id:"kawamurahakuto"},
  {name:"村松 遼空(HARUKU)", img:"https://i.imgur.com/3JEtKs6.png", id:"muramatsuharuku"},
  {name:"髙城 暖人(HARUTO)", img:"https://i.imgur.com/qdXIOpr.png", id:"takagiharuto"},
  {name:"平島 輝(H.HIKARU)", img:"https://i.imgur.com/P5gzRZh.png", id:"hirashimahikaru"},
  {name:"櫻井 輝(S.HIKARU)", img:"https://i.imgur.com/h2fBMUv.png", id:"sakuraihikaru"},
  {name:"佐川 太一(HIROKAZU)", img:"https://i.imgur.com/h2fBMUv.png", id:"sagawahirokazu"},
  {name:"イ・ヒョンジェ(HYUNJAE)", img:"https://i.imgur.com/wOhvKDu.png", id:"leehyunjae"},
  {name:"阿部 樹(ITSUKI)", img:"https://i.imgur.com/TaTAc2L.png", id:"abeitsuki"},
  {name:"イ・ジュンフン(JOONGHOON)", img:"https://i.imgur.com/4utwyOJ.png", id:"leejoonghoon"},
  {name:"リュウ・カイチ(KAICHI)", img:"https://i.imgur.com/FGbdGcI.png", id:"liukaichi"},
  {name:"黒﨑 貫汰(KANTA)", img:"https://i.imgur.com/j75eoO7.png", id:"kurosakikanta"},
  {name:"黄 敬眞(KEISHIN)", img:"https://i.imgur.com/oE7w4D7.png", id:"kokeishin"},
  {name:"釼持 吉成(KINARI)", img:"https://i.imgur.com/GWAtiwS.png", id:"kenmotsukinari"},
  {name:"小澤 昂心(KOSHIN)", img:"https://i.imgur.com/pn0zB7F.png", id:"ozawakoshin"},
  {name:"青沼 昂史朗(KOSHIRO)", img:"https://i.imgur.com/MDhTcs8.png", id:"aonumakoshiro"},
  {name:"小林 廣(KOU)", img:"https://i.imgur.com/RAoUIhC.png", id:"kobayashikou"},
  {name:"森 明育(MEI)", img:"https://i.imgur.com/eR0BZVs.png", id:"morimei"},
  {name:"マイケル ミン・マカフリ(MICHAEL MINH)", img:"https://i.imgur.com/6S8BWAA.png", id:"michaelminhmccaffrey"},
  {name:"パトリック ファン・レ(PATRICK)", img:"https://i.imgur.com/YRvJQYc.png", id:"patrickphanle"},
  {name:"笠原 蓮(KA.REN)", img:"https://i.imgur.com/ZLgNm7o.png", id:"kasahararen"},
  {name:"江口 蓮翔(E.RENTO)", img:"https://i.imgur.com/ewXd8NH.png", id:"eguchirento"},
  {name:"小林 蓮翔(K.RENTO)", img:"https://i.imgur.com/t2NbxIU.png", id:"kobayashirento"},
  {name:"落合 利温(RIO)", img:"https://i.imgur.com/HdTZUdu.png", id:"ochiairio"},
  {name:"水上 琉偉(M.RUI)", img:"https://i.imgur.com/DiUA9bw.png", id:"mizugamirui"},
  {name:"小谷内 瑠嘉(RUKA)", img:"https://i.imgur.com/V2XnsQ6.png", id:"koyauchiruka"},
  {name:"齊藤 惺(SEI)", img:"https://i.imgur.com/9HIRvNd.png", id:"saitosei"},
  {name:"藤本 真成(SHINSEI)", img:"https://i.imgur.com/qTooOuS.png", id:"fujimotoshinsei"},
  {name:"飯田 柊馬(SHUMA)", img:"https://i.imgur.com/awBBn6j.png", id:"iidashuma"},
  {name:"松田 颯吾(SOGO)", img:"https://i.imgur.com/Y1MQK3k.png", id:"matsudasogo"},
  {name:"髙橋 空良(T.SORA)", img:"https://i.imgur.com/czFpgjm.png", id:"takahashisora"},
  {name:"西田 颯梓(SOSHI)", img:"https://i.imgur.com/51RMIB6.png", id:"nishidasoshi"},
  {name:"岡本 拓士(O.TAKUTO)", img:"https://i.imgur.com/TGP6sbe.png", id:"okamototakuto"},
  {name:"大澤 佑冴(YUGO)", img:"https://i.imgur.com/5Gg1E1M.png", id:"osawayugo"},
  {name:"藤井 雄聖(F.YUSEI)", img:"https://i.imgur.com/prsNOtG.png", id:"fujiiyusei"},
  {name:"岡本 佑斗(YUTO)", img:"https://i.imgur.com/lzv8Vu5.png", id:"okamotoyuto"}
];
/* ====== ここまで ====== */

const MAX = 11;

// UI elements
const toggleBtn = document.getElementById("toggleBtn");
const modePill  = document.getElementById("modePill");
const searchEl  = document.getElementById("search");
const gridEl    = document.getElementById("grid");
const slotsEl   = document.getElementById("slots");
const countEl   = document.getElementById("count");
const voteBtn   = document.getElementById("voteBtn");
const clearBtn  = document.getElementById("clearBtn");
const undoBtn   = document.getElementById("undoBtn");
const resultCountEl = document.getElementById("resultCount");

// state
let showCandidates = false;     // URL触った時は練習生 = false
let selected = [];              // 選択順を保持（undo用）
let selectedSet = new Set();    // 高速判定
let lastActionStack = [];       // undo用（idを積む）

// ==== 検索強化（英字/記号/全角半角）====
function normalizeText(s){
  return (s || "")
    .toString()
    .normalize("NFKC")
    .toLowerCase()
    .replace(/[\s\.\-_/()（）]/g,""); // 記号を無視（S.AYUMU → sayumu）
}
function buildSearchKey(t){
  // name（日本語＋括弧英字）と id を検索対象に
  return [t.name || "", t.id || ""].map(normalizeText).join(" ");
}

// 合体データ（searchKey 付き）
const trainees = traineesOnly.map(x => {
  const obj = {...x, group:"trainee"};
  obj.searchKey = buildSearchKey(obj);
  return obj;
});
const candis   = candidates.map(x => {
  const obj = {...x, group:"candidate"};
  obj.searchKey = buildSearchKey(obj);
  return obj;
});

// ID参照
const byId = new Map([...trainees, ...candis].map(x => [x.id, x]));

// ==== scroll位置保持（「勝手に上に戻らない」対策）====
function preserveScroll(fn){
  const y = window.scrollY;
  fn();
  requestAnimationFrame(() => window.scrollTo(0, y));
}

// ==== 表示モード ====
function currentList(){
  return showCandidates ? candis : trainees;
}
function setModeUI(){
  modePill.textContent = showCandidates ? "表示：練習生候補" : "表示：練習生";
  toggleBtn.textContent = showCandidates ? "練習生を表示" : "練習生候補を表示";
}

// ==== 上の11枠 ====
function renderSlots(){
  slotsEl.innerHTML = "";
  for(let i=0;i<MAX;i++){
    const id = selected[i];
    const slot = document.createElement("div");
    slot.className = "slot" + (id ? " filled" : "");
    if(id){
      const t = byId.get(id);
      slot.innerHTML = `
        <img src="${t?.img || ""}" alt="">
        <div class="x" data-remove="${id}">×</div>
      `;
    } else {
      slot.textContent = "+";
    }
    slotsEl.appendChild(slot);
  }
}

// slot remove (tap ×)
slotsEl.addEventListener("click", (e) => {
  const btn = e.target.closest("[data-remove]");
  if(!btn) return;
  const id = btn.getAttribute("data-remove");
  removeSelected(id);
});

// ==== 一覧（2列） ====
function renderGrid(){
  const qRaw = searchEl.value.trim();
  const q = normalizeText(qRaw);

  const list = currentList().filter(t => {
    if(!q) return true;

    // 生文字（日本語）検索も通す
    const rawHit =
      (t.name || "").toLowerCase().includes(qRaw.toLowerCase()) ||
      (t.id || "").toLowerCase().includes(qRaw.toLowerCase());

    // 英字強化（記号無視）検索
    const keyHit = (t.searchKey || "").includes(q);

    return rawHit || keyHit;
  });

  resultCountEl.textContent = `${list.length}件`;

  gridEl.innerHTML = "";
  for(const t of list){
    const picked = selectedSet.has(t.id);
    const card = document.createElement("div");
    card.className = "card" + (picked ? " picked" : "");
    card.setAttribute("data-id", t.id);

    card.innerHTML = `
      <div class="avatar">
        <img src="${t.img}" alt="">
        <a class="profileBtn"
           href="https://produce101.jp/profile/detail/?id=${encodeURIComponent(t.id)}"
           target="_blank" rel="noopener noreferrer"
           data-profile-link="1">profile</a>
      </div>

      <div class="info">
        <div class="name">${t.name}</div>
        <div class="meta">${showCandidates ? "練習生候補" : "練習生"}</div>
      </div>
    `;

    gridEl.appendChild(card);
  }
}

// card click add/remove（profileを押した時は選択しない）
gridEl.addEventListener("click", (e) => {
  if (e.target.closest('[data-profile-link="1"]')) return;

  const card = e.target.closest(".card");
  if(!card) return;
  const id = card.getAttribute("data-id");
  if(!id) return;

  preserveScroll(() => {
    if(selectedSet.has(id)){
      removeSelected(id);
    }else{
      addSelected(id);
    }
  });
});

// ==== 選択処理 ====
function addSelected(id){
  if(selectedSet.has(id)) return;
  if(selected.length >= MAX){
    alert(`最大${MAX}人までです`);
    return;
  }
  selected.push(id);
  selectedSet.add(id);
  lastActionStack.push({type:"add", id});
  updateAll();
}
function removeSelected(id){
  if(!selectedSet.has(id)) return;
  selected = selected.filter(x => x !== id);
  selectedSet.delete(id);
  lastActionStack.push({type:"remove", id});
  updateAll();
}
function undo(){
  const last = lastActionStack.pop();
  if(!last) return;
  if(last.type === "add"){
    selected = selected.filter(x => x !== last.id);
    selectedSet.delete(last.id);
  } else {
    if(selected.length < MAX && !selectedSet.has(last.id)){
      selected.push(last.id);
      selectedSet.add(last.id);
    }
  }
  updateAll();
}
function clearAll(){
  selected = [];
  selectedSet.clear();
  lastActionStack = [];
  updateAll();
}

// ==== 更新 ====
function updateAll(){
  countEl.textContent = String(selected.length);
  voteBtn.disabled = selected.length !== MAX;
  voteBtn.textContent = (selected.length === MAX) ? "投票する" : `あと ${MAX - selected.length} 人`;

  renderSlots();
  renderGrid();
}

// ==== モード切替（ボタン1つでトグル） ====
toggleBtn.addEventListener("click", () => {
  preserveScroll(() => {
    showCandidates = !showCandidates;
    setModeUI();
    renderGrid();
  });
});

// ==== 検索 ====
searchEl.addEventListener("input", () => {
  preserveScroll(() => renderGrid());
});

// ==== ボタン ====
undoBtn.addEventListener("click", () => preserveScroll(() => undo()));
clearBtn.addEventListener("click", () => {
  if(!confirm("選択をリセットしますか？")) return;
  preserveScroll(() => clearAll());
});

voteBtn.addEventListener("click", () => {
  if(selected.length !== MAX) return;
  // ここに「投票送信（集計）」を後で合体できる
  const names = selected.map(id => byId.get(id)?.name || id);
  alert("投票（仮）\n\n" + names.join("\n"));
});

// 初期描画
setModeUI();
renderSlots();
renderGrid();
updateAll();
</script>
</body>
</html>
