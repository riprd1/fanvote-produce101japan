<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>PRODUCE101JAPANæ–°ä¸–ç•Œãƒ•ã‚¡ãƒ³æŠ•ç¥¨ã‚µã‚¤ãƒˆ</title>

<style>
  :root{
    --bg:#f6f6f6;
    --card:#ffffff;
    --line:#e6e6e6;
    --text:#111;
    --muted:#666;
    --shadow: 0 4px 14px rgba(0,0,0,.06);
    --radius:14px;
    --blue:#0080ff;

    --slot: 86px;
    --gap:  14px;

    --exAvatar: 112px;
    --exBorder: 8px;
    --exGapX: 56px;
    --exGapY: 30px;
    --exName: 15px;
  }

  *{ box-sizing:border-box; }
  body{
    margin:0;
    font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
    background:var(--bg);
    color:var(--text);
  }

  header{
    position: sticky;
    top: 0;
    z-index: 50;
    background: rgba(255,255,255,.92);
    backdrop-filter: blur(10px);
    border-bottom: 1px solid var(--line);
  }
  .topbar{ padding: 12px 12px 10px; max-width: 980px; margin: 0 auto; }
  h1{margin:0;font-size:18px;line-height:1.2}

  main{max-width:980px;margin:0 auto;padding:12px;}
  .card{
    background: var(--card);
    border: 1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    overflow: hidden;
  }

  /* ===== ç”»é¢è¡¨ç¤ºãƒãƒŠãƒ¼ ===== */
  .banner{
    height: 110px;
    position: relative;
    display:flex;
    align-items:center;
    justify-content:center;
    background:
      radial-gradient(circle at 20% 30%, rgba(255,120,200,.30), transparent 40%),
      radial-gradient(circle at 80% 40%, rgba(120,160,255,.28), transparent 45%),
      linear-gradient(135deg, #ffe7f4, #eef3ff);
  }
  .banner.hasImage{ background-size: cover; background-position: center; }
  .banner::after{
    content:"";
    position:absolute; inset:0;
    background: linear-gradient(to bottom, rgba(255,255,255,.0), rgba(255,255,255,.35));
    pointer-events:none;
  }
  .bannerTitle{
    position:relative;
    font-weight: 900;
    letter-spacing: .04em;
    padding: 10px 14px;
    border-radius: 999px;
    background: rgba(255,255,255,.78);
    border: 1px solid rgba(255,255,255,.9);
    font-size: 13px;
    z-index: 2;
    white-space: nowrap;
  }
  .slotBadge{
    position:absolute;
    right: 12px;
    bottom: 12px;
    background: rgba(0,128,255,.92);
    color: #fff;
    font-weight: 900;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 14px;
    box-shadow: 0 8px 18px rgba(0,0,0,.14);
    z-index: 5;
    white-space: nowrap;
    pointer-events:none;
  }

  /* ===== ä¸Šï¼šé¸æŠæ ï¼ˆèƒŒæ™¯ç”»åƒãã®ã¾ã¾ï¼‰ ===== */
  .picksWrap{
    padding: 12px 14px 8px;
    background-image: url("https://i.imgur.com/lFGbXfI.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;
  }
  .picksRow{
    display:flex;
    justify-content:center;
    gap: var(--gap);
    flex-wrap: wrap;
    row-gap: 14px;
    padding: 12px 0 10px;
  }
  .slot{ width: var(--slot); text-align:center; }
  .avatar{
    width: var(--slot);
    height: var(--slot);
    border-radius:999px;
    border: 5px solid var(--blue);
    background:#fff;
    overflow: visible;
    box-shadow: 0 8px 18px rgba(0,0,0,.10);
    margin: 0 auto;
    position:relative;
    z-index: 1;
  }
  .avatar img{
    width:100%;
    height:100%;
    border-radius:999px;
    object-fit: cover;
    object-position: 50% 35%;
    display:block;

    image-rendering: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  .rank{
    position:absolute;
    left:50%;
    bottom:-12px;
    transform: translateX(-50%);
    background: var(--blue);
    color:#fff;
    border-radius:999px;
    font-weight:900;
    font-size: 9px;
    padding: 6px 8px;
    line-height:1;
    min-width: 2.0em;
    text-align:center;
    z-index: 2;
    box-shadow: 0 6px 14px rgba(0,0,0,.18);
    pointer-events:none;
  }
  .name{
    margin-top: 14px;
    font-size: 12px;
    font-weight: 900;
    line-height: 1.1;
    white-space: nowrap;
    overflow:hidden;
    text-overflow: ellipsis;
  }
  .empty .avatar{
    opacity:.16;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 34px;
    font-weight: 900;
    color:#555;
  }
  .empty .rank{display:none;}
  .empty .name{display:none;}

  .reorder{ display:none; gap:10px; justify-content:center; margin-top: 8px; }
  body.reorder-on .reorder{ display:flex; }
  .reorder button{
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 16px;
    line-height: 1;
  }

  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    justify-content:center;
    padding: 10px 10px 12px;
    border-top: 1px solid #f1f1f1;
    background:#fff;
  }
  button{
    padding: 11px 12px;
    border-radius: 12px;
    border: 1px solid #ddd;
    background: #fff;
    font-size: 14px;
  }
  button:active{transform:scale(.98)}
  .primary{border-color:#cfe2ff;}
  .danger{border-color:#ffd6d6;}
  .mode{border-color:#e7e7e7;}

  /* TikTokèª˜å°ï¼ˆã‚µã‚¤ãƒˆä¸Šï¼‰ */
  .tiktokBtn{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    padding: 11px 14px;
    border-radius: 12px;
    font-size: 14px;
    font-weight: 900;
    text-decoration: none;
    color: #fff;
    background: linear-gradient(135deg, #000000, #222222);
    border: 1px solid #111;
    box-shadow: 0 6px 14px rgba(0,0,0,.18);
  }
  .tiktokBtn:active{ transform: scale(.98); }
  .tiktokHint{
    margin-top: 6px;
    font-size: 13px;
    font-weight: 900;
    color: #555;
    text-align: center;
    letter-spacing: .02em;
  }
  .tiktokWrap{ display:flex; flex-direction:column; align-items:center; }

  /* ===== ä¸€è¦§ï¼š2åˆ—ãƒœã‚¿ãƒ³ ===== */
  .listCard{
    margin-top: 12px;
    padding: 10px;

    background-image: url("https://i.imgur.com/lUMY5QA.png");
    background-size: cover;
    background-position: center;
    background-repeat: no-repeat;

    border:1px solid var(--line);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }

  .sectionTitle{
    font-size: 18px;
    font-weight: 900;
    padding: 6px 2px 10px;
    color: #fff;
    text-shadow: 0 2px 6px rgba(0,0,0,0.35);
  }

  .searchRow{ display:flex; gap:10px; align-items:center; margin-bottom: 10px; }
  .search{
    flex:1;
    display:flex;
    align-items:center;
    border:1px solid #ddd;
    border-radius: 12px;
    padding: 10px 12px;
    background:#fff;
  }
  .search input{ border:none; outline:none; width:100%; font-size: 15px; background:transparent; }
  #membersWrap{
    max-height: 52vh;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    border-top:1px solid #f1f1f1;
    padding-top: 6px;
    overscroll-behavior: contain;
  }
  .membersGrid{
    display:grid;
    grid-template-columns: repeat(2, minmax(0, 1fr));
    gap:12px;
    padding: 10px 6px 6px;
  }
  .memberCard{
    border: 1px solid #e8e8e8;
    border-radius: 16px;
    background: #fff;
    box-shadow: 0 4px 14px rgba(0,0,0,.06);
    padding: 12px 10px 10px;
    cursor:pointer;
    user-select:none;
    text-align:center;
    position:relative;
  }
  .memberCard:active{ transform:scale(.99); }
  .memberCardThumb{
    width:100%;
    aspect-ratio: 1 / 1;
    border-radius: 14px;
    overflow:hidden;
    background:#f7f7f7;
    border:1px solid #f0f0f0;
  }
  .memberCardThumb img{
    width:100%;
    height:100%;
    object-fit: cover;
    object-position: 50% 20%;
    display:block;

    image-rendering: auto;
    transform: translateZ(0);
    backface-visibility: hidden;
  }
  .memberCardName{ margin-top:10px; font-weight:900; font-size:14px; line-height:1.2; }
  .memberCardSub{ margin-top:4px; font-size:12px; color: var(--muted); }
  .memberCard.selected{ opacity:.35; filter: grayscale(1); pointer-events:none; }
  .memberCardProfile{
    position:absolute;
    right:10px;
    top:10px;
    font-size:12px;
    font-weight:900;
    padding: 7px 10px;
    border-radius: 999px;
    border: 1px solid #cfe2ff;
    color: var(--blue);
    background: rgba(255,255,255,.92);
    text-decoration:none;
    line-height:1;
  }

  .toast{
    position: fixed;
    left: 50%;
    bottom: 18px;
    transform: translateX(-50%);
    background: rgba(0,0,0,.78);
    color:#fff;
    padding: 10px 12px;
    border-radius: 999px;
    font-size: 13px;
    display:none;
    z-index:999;
  }

  /* ===== æŠ•ç¥¨å®Œäº†ãƒãƒƒãƒ—ï¼ˆç·‘ãƒã‚§ãƒƒã‚¯ï¼‰ ===== */
  .voteSuccess{
    position: fixed;
    inset: 0;
    display:none;
    align-items:center;
    justify-content:center;
    background: rgba(0,0,0,.35);
    z-index: 99999;
  }
  .voteSuccess.show{ display:flex; }

  .voteSuccessBox{
    background: rgba(255,255,255,.94);
    border: 1px solid rgba(255,255,255,.9);
    border-radius: 18px;
    padding: 18px 18px 14px;
    box-shadow: 0 18px 46px rgba(0,0,0,.22);
    backdrop-filter: blur(10px);
    text-align:center;
    min-width: 240px;
  }

  .voteCheck{
    width: 76px;
    height: 76px;
    margin: 0 auto 10px;
    border-radius: 999px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size: 44px;
    font-weight: 1000;
    color: #fff;
    background: #23c552;
    box-shadow: 0 12px 24px rgba(35,197,82,.35);
    transform: scale(.72);
    opacity: 0;
  }

  .voteSuccessText{
    font-weight: 1000;
    letter-spacing: .02em;
    font-size: 15px;
    color:#111;
    opacity: 0;
    transform: translateY(6px);
  }

  .voteSuccess.show .voteCheck{
    animation: popCheck .46s cubic-bezier(.2, 1.2, .25, 1) forwards;
  }
  .voteSuccess.show .voteSuccessText{
    animation: popText .36s ease forwards;
    animation-delay: .08s;
  }

  @keyframes popCheck{
    0%   { transform: scale(.65); opacity: 0; }
    70%  { transform: scale(1.12); opacity: 1; }
    100% { transform: scale(1.00); opacity: 1; }
  }
  @keyframes popText{
    0%   { transform: translateY(8px); opacity: 0; }
    100% { transform: translateY(0); opacity: 1; }
  }

  /* ===== è¿½åŠ ã‚«ãƒ¼ãƒ‰ï¼ˆèª•ç”Ÿæ—¥/é‹å‹¢/ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰ ===== */
  .miniCard{
    margin-top: 12px;
    padding: 12px;
  }
  .miniTitle{
    font-weight: 1000;
    margin: 2px 0 10px;
  }
  .pill{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding: 8px 12px;
    border-radius: 999px;
    border: 1px solid #e8e8e8;
    background:#fff;
    font-weight: 900;
  }
  .grid3{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 10px;
    margin-top: 10px;
  }
  .fortuneBox{
    border: 1px solid #eee;
    border-radius: 14px;
    background:#fff;
    padding: 10px;
  }
  .fortuneLabel{
    font-weight: 1000;
    color:#333;
    margin-bottom: 8px;
  }
  .fortuneList{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
  }
  .tag{
    padding: 6px 10px;
    border-radius: 999px;
    border: 1px solid #eaeaea;
    background:#fafafa;
    font-weight: 900;
    font-size: 12px;
  }
  .fortuneComment{
    margin-top: 10px;
    font-weight: 900;
    color:#333;
    line-height:1.5;
    font-size: 13px;
  }
  .rankScroll{
    max-height: 60vh;
    overflow:auto;
    -webkit-overflow-scrolling: touch;
    overscroll-behavior: contain;
  }
  .rankRow{
    display:flex; align-items:center; gap:10px;
    background:#fff; border:1px solid #eee; border-radius:12px; padding:10px;
  }
  .rankNum{ font-weight:1000; width:2.6em; text-align:right; }
  .rankImg{ width:44px;height:44px;border-radius:12px;object-fit:cover;border:1px solid #eee; }
  .rankName{ flex:1; font-weight:900; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .rankVotes{ font-weight:1000; color:#0080ff; }

</style>
</head>

<body>
<header>
  <div class="topbar">
    <h1>PRODUCE101JAPANæ–°ä¸–ç•Œãƒ•ã‚¡ãƒ³æŠ•ç¥¨ã‚µã‚¤ãƒˆ</h1>
  </div>
</header>

<main>

  <!-- â˜…èª•ç”Ÿæ—¥ -->
  <div class="card miniCard">
    <div class="miniTitle">ğŸ‚ æœ¬æ—¥èª•ç”Ÿæ—¥ï¼ˆç·´ç¿’ç”Ÿï¼‹ç·´ç¿’ç”Ÿå€™è£œï¼‰</div>
    <div id="birthdayWrap" style="display:flex; gap:10px; flex-wrap:wrap;"></div>
    <div id="birthdayEmpty" style="margin-top:8px;color:#666;font-weight:900;display:none;">æœ¬æ—¥èª•ç”Ÿæ—¥ã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ã„ã¾ã›ã‚“</div>
  </div>

  <!-- â˜…ä»Šæ—¥ã®é‹å‹¢ï¼ˆAIç”Ÿæˆï¼šDBã‹ã‚‰èª­ã‚€ï¼‰ -->
  <div class="card miniCard">
    <div class="miniTitle">ğŸ€ ä»Šæ—¥ã®é‹å‹¢ï¼ˆKSTï¼‰</div>
    <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center;">
      <div class="pill">æ›´æ–°ï¼š<span id="fortuneDate">â€”</span></div>
      <div class="pill">â€»æ¯æ—¥KST 0:00ã«AIãŒç”Ÿæˆï¼ˆè¡¨ç¤ºã¯ãã®æ—¥å›ºå®šï¼‰</div>
    </div>

    <div class="grid3">
      <div class="fortuneBox">
        <div class="fortuneLabel">å¼·é‹MBTI TOP3</div>
        <div id="mbtiList" class="fortuneList"></div>
      </div>
      <div class="fortuneBox">
        <div class="fortuneLabel">å¼·é‹æ˜Ÿåº§ TOP3</div>
        <div id="zodiacList" class="fortuneList"></div>
      </div>
      <div class="fortuneBox">
        <div class="fortuneLabel">ã²ã¨ã“ã¨</div>
        <div id="fortuneComment" class="fortuneComment">ç”Ÿæˆä¸­â€¦</div>
      </div>
    </div>
  </div>

  <!-- â˜…æŠ•ç¥¨ï¼‹ä¸€è¦§ -->
  <div class="card" id="picksCard">
    <div id="banner" class="banner">
      <div class="bannerTitle">PRODUCE101JAPANæ–°ä¸–ç•Œãƒ•ã‚¡ãƒ³æŠ•ç¥¨ã‚µã‚¤ãƒˆ</div>
      <div class="slotBadge" id="slotBadge">KSTã§1æ—¥1å›</div>
    </div>

    <div class="picksWrap" id="picksWrap">
      <div class="picksRow" id="picksRow"></div>
    </div>

    <div class="actions">
      <!-- â˜…æŠ•ç¥¨ãƒœã‚¿ãƒ³ï¼š11äººã¡ã‚‡ã†ã©ï¼‹CAPTCHAå¿…é ˆ -->
      <button class="primary" type="button" onclick="submitVote()">æŠ•ç¥¨ã™ã‚‹ï¼ˆ11äººå¿…é ˆï¼‰</button>

      <!-- ä»»æ„ï¼šãƒ­ãƒ¼ã‚«ãƒ«ç”»åƒä¿å­˜ï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ã‚’æ®‹ã—ãŸã„å ´åˆã¯ã“ã“ã«ãƒœã‚¿ãƒ³è¿½åŠ ã—ã¦OKï¼‰ -->
      <button type="button" onclick="undo()">1äººæˆ»ã™</button>
      <button class="danger" type="button" onclick="resetAll()">ãƒªã‚»ãƒƒãƒˆ</button>
      <button class="mode" type="button" id="reorderBtn" onclick="toggleReorder()">ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼šOFF</button>

      <div class="tiktokWrap">
        <a class="tiktokBtn" href="https://www.tiktok.com/@12agassi" target="_blank" rel="noopener">TikTokãƒ•ã‚©ãƒ­ãƒ¼ãŠé¡˜ã„ğŸ¥¹</a>
        <div class="tiktokHint">â†‘ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯</div>
      </div>

      <!-- Turnstile CAPTCHA -->
      <div style="width:100%; display:flex; justify-content:center; padding-top:4px;">
        <div class="cf-turnstile" data-sitekey="0x4AAAAAACY81iQ7qT0skFkZ"></div>
      </div>

      <div style="width:100%; text-align:center; color:#666; font-weight:900; font-size:12px;">
        â€»æŠ•ç¥¨ã¯KSTåŸºæº–ã§1æ—¥1å› / 11äººã¡ã‚‡ã†ã©å¿…é ˆ / CAPTCHAå¿…é ˆ
      </div>
    </div>
  </div>

  <!-- â˜…ãƒ©ãƒ³ã‚­ãƒ³ã‚° -->
  <div class="card miniCard">
    <div class="miniTitle">ğŸ† ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå…¨å“¡è¡¨ç¤ºãƒ»0ç¥¨ã‚‚å«ã‚€ï¼‰</div>
    <div style="display:flex; gap:10px; justify-content:center; padding:0 0 10px; flex-wrap:wrap;">
      <button type="button" class="mode" onclick="setRankingMode('daily')">ä»Šæ—¥ï¼ˆKSTï¼‰</button>
      <button type="button" class="mode" onclick="setRankingMode('total')">ç´¯è¨ˆ</button>
      <button type="button" class="mode" onclick="refreshRankings()">æ›´æ–°</button>
    </div>
    <div id="rankWrap" class="rankScroll"></div>
  </div>

  <!-- ä¸€è¦§ -->
  <div class="listCard">
    <div class="sectionTitle">ä¸€è¦§ï¼ˆæŠ¼ã—ã¦è¿½åŠ ï¼‰</div>
    <div class="searchRow">
      <div class="search">
        <input id="search" type="text" placeholder="Search" oninput="drawMembers()" />
      </div>
      <button class="mode" id="toggleListBtn" type="button" onclick="toggleCandidates(event)">ç·´ç¿’ç”Ÿå€™è£œ</button>
    </div>

    <div id="membersWrap">
      <div id="members" class="membersGrid"></div>
    </div>
  </div>

</main>

<div class="toast" id="toast">å‡¦ç†ä¸­â€¦</div>

<!-- æŠ•ç¥¨å®Œäº†ãƒãƒƒãƒ— -->
<div id="voteSuccess" class="voteSuccess" aria-hidden="true">
  <div class="voteSuccessBox">
    <div class="voteCheck" aria-hidden="true">âœ“</div>
    <div class="voteSuccessText">æŠ•ç¥¨ãŒå®Œäº†ã—ã¾ã—ãŸ</div>
  </div>
</div>

<!-- Turnstile -->
<script src="https://challenges.cloudflare.com/turnstile/v0/api.js" async defer></script>

<!-- Supabase -->
<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

  // ===========================
  // â˜…ã“ã“ã‚’è‡ªåˆ†ã®å€¤ã«ç½®æ›
  // ===========================
  const SUPABASE_URL = "https://qxzdozlczrqpzkqczswo.supabase.co"
const SUPABASE_ANON_KEY = "sb_publishable_CJTpa0x7kCFYfiulILfbww_oIxrincX"
const FUNCTIONS_URL = "https://qxzdozlczrqpzkqczswo.supabase.co/functions/v1"
  // ä¾‹: submit-vote Edge Function URL -> `${FUNCTIONS_URL}/submit-vote`
  // ===========================

  window.__CFG = { SUPABASE_URL, SUPABASE_ANON_KEY, FUNCTIONS_URL };
  window.sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
</script>

<script>
/* =========================================================
  ä½¿ã„æ–¹ï¼ˆé‡è¦ï¼‰
  1) YOUR_TURNSTILE_SITE_KEY ã‚’è‡ªåˆ†ã®Site Keyã«ç½®æ›
  2) Supabase URL / anon key / functions URL ã‚’ç½®æ›
  3) Edge Function: submit-vote ã‚’ä½œã£ã¦ãŠãï¼ˆTurnstileæ¤œè¨¼ï¼†æŠ•ç¥¨ï¼‰
  4) RPC: get_daily_ranking / get_total_ranking ã‚’ä½œã£ã¦ãŠã
  5) AIé‹å‹¢ï¼šdaily_fortunes ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆä¾‹ï¼‰ã‚’ä½œã£ã¦ã€KST 0:00ã«ç”Ÿæˆã—ã¦ä¿å­˜
     - ã“ã“ã§ã¯ â€œèª­ã‚€ã ã‘â€ å®Ÿè£…
  6) èª•ç”Ÿæ—¥ã¯ã€ä¸‹ã® BIRTHDAYS ã« id -> "MM-DD" ã‚’å…¥ã‚Œã‚‹ï¼ˆç·´ç¿’ç”Ÿï¼‹å€™è£œï¼‰
     ï¼ˆå°†æ¥DBç®¡ç†ã«ã™ã‚‹ãªã‚‰ã€ã“ã“ã‚’DBã‹ã‚‰èª­ã‚€ã‚ˆã†ã«å¤‰æ›´ã™ã‚Œã°OKï¼‰
========================================================= */

const HEADER_IMAGE_URL = "https://i.imgur.com/nYBRUdd.png";
const FALLBACK_IMG = "data:image/gif;base64,R0lGODlhAQABAAAAACw=";

// â˜…èª•ç”Ÿæ—¥ãƒ‡ãƒ¼ã‚¿ï¼ˆå¿…é ˆï¼‰: id -> "MM-DD"ï¼ˆç·´ç¿’ç”Ÿï¼‹å€™è£œ ä¸¡æ–¹å…¥ã‚Œã¦OKï¼‰
// ä¾‹: { "adamnagai": "02-08", "honjoakira": "11-03" }
const BIRTHDAYS = {
  // TODO: ã“ã“ã«è¿½åŠ ã—ã¦ã„ã
};

// â˜…é‹å‹¢ï¼ˆAIç”Ÿæˆï¼‰ã‚’ä¿å­˜ã—ã¦ã‚ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«åï¼ˆã‚ãªãŸã®DBã«åˆã‚ã›ã¦å¤‰æ›´ï¼‰
const FORTUNE_TABLE = "daily_fortunes"; // ä¾‹: date, mbti_top3(text[]), zodiac_top3(text[]), comment(text)

// æŠ•ç¥¨ã¯ 11äººå›ºå®š
const MAX_PICK = 11;

const STORAGE_KEY  = "fanvote_selected_v1";

let showingCandidates = false;

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ‰
let rankingMode = "daily";

// æ—¢å­˜ï¼šè¡¨ç¤ºè£œåŠ©
function profileUrlById(id){
  if(!id) return "https://produce101.jp/profile/detail/?lang=ja";
  return "https://produce101.jp/profile/detail/?id=" + encodeURIComponent(id) + "&lang=ja";
}
function displayName(full){
  return (full || "").replace(/\s*\([^)]*\)\s*/g, "").trim();
}
function alphaPart(full){
  const m = (full||"").match(/\(([^)]*)\)/);
  return m ? "(" + m[1] + ")" : "";
}

/* ===== KSTæ—¥ä»˜ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ===== */
function kstDateKey(){
  const fmt = new Intl.DateTimeFormat("en-CA", { timeZone: "Asia/Seoul", year:"numeric", month:"2-digit", day:"2-digit" });
  return fmt.format(new Date()); // YYYY-MM-DD
}
function kstMonthDay(){
  const fmt = new Intl.DateTimeFormat("en-CA", { timeZone: "Asia/Seoul", month:"2-digit", day:"2-digit" });
  const s = fmt.format(new Date()); // MM-DD
  return s;
}
function kstNowParts(){
  const fmt = new Intl.DateTimeFormat("en-CA", {
    timeZone: "Asia/Seoul",
    year: "numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit",
    hourCycle:"h23"
  });
  const parts = fmt.formatToParts(new Date());
  const get = (t)=>parts.find(p=>p.type===t)?.value;
  return {
    y: Number(get("year")),
    m: Number(get("month")),
    d: Number(get("day")),
    hh: Number(get("hour")),
    mm: Number(get("minute")),
    ss: Number(get("second"))
  };
}
function msUntilNextKstMidnight(){
  const p = kstNowParts();
  const secNow = p.hh*3600 + p.mm*60 + p.ss;
  const secToNext = 24*3600 - secNow;
  return Math.max(500, secToNext * 1000 + 50);
}
function scheduleDailyAutoRefresh(){
  const first = msUntilNextKstMidnight();
  window.setTimeout(async () => {
    // æ—¥ä»˜åˆ‡ã‚Šæ›¿ãˆã‚¿ã‚¤ãƒŸãƒ³ã‚°
    await refreshBirthdays();
    await refreshFortune();
    await refreshRankings();
    scheduleDailyAutoRefresh();
  }, first);
}

/* ===== æŠ•ç¥¨å®Œäº†ãƒãƒƒãƒ— ===== */
function showVoteSuccessPop(){
  const el = document.getElementById("voteSuccess");
  if(!el) return;
  el.classList.add("show");
  el.setAttribute("aria-hidden","false");
  window.clearTimeout(showVoteSuccessPop._t);
  showVoteSuccessPop._t = window.setTimeout(() => {
    el.classList.remove("show");
    el.setAttribute("aria-hidden","true");
  }, 1100);
}
document.addEventListener("click", (e)=>{
  const el = document.getElementById("voteSuccess");
  if(!el) return;
  if(el.classList.contains("show") && e.target === el){
    el.classList.remove("show");
    el.setAttribute("aria-hidden","true");
  }
});

/* ====== ç·´ç¿’ç”Ÿãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ãªãŸã®ã€Œãã®ã¾ã¾ã€ï¼‰ ====== */
const traineesOnly = [
  {name:"ã‚¢ãƒ€ãƒ ãƒ»ãƒŠã‚¬ã‚¤(ADAM)", img:"https://i.imgur.com/6QGzvRx.png", id:"adamnagai"},
  {name:"ä¸­ä¸¸ æ™å¯¿(AJU)", img:"https://i.imgur.com/KiZCKos.png", id:"nakamaruaju"},
  {name:"ã‚ªãƒ ãƒ»ã‚¹ã‚¢ãƒ³ã‚«ãƒ¯ãƒ¼ãƒ†ãƒ³(AOM)", img:"https://i.imgur.com/dDIFJSc.png", id:"aomsuungkavathin"},
  {name:"ã‚¢ãƒ¼ãƒãƒ£ãƒ¼ãƒ»ã‚¦ã‚¤(ARCHER)", img:"https://i.imgur.com/5iIerqN.png", id:"archeruy"},
  {name:"ç¯ ãƒ¶è°· æ­©å¤¢(S.AYUMU)", img:"https://i.imgur.com/YJAdh8q.png", id:"shinogayaayumu"},
  {name:"å°æ— åƒæ‚Ÿ(CHISATO)", img:"https://i.imgur.com/Iu0hNBO.png", id:"kobayashichisato"},
  {name:"åŠ è—¤ å¤§æ¨¹ (K.DAIKI)", img:"https://i.imgur.com/4fRk2EB.png", id:"katodaiki"},
  {name:"ã‚«ã‚¯ãƒ»ãƒ‰ãƒ³ãƒŸãƒ³(DONGMIN)", img:"https://i.imgur.com/xZSQqMh.png", id:"kwakdongmin"},
  {name:"æœ«å· ç‘›å¤ª(EITA)", img:"https://i.imgur.com/alEjKCP.png", id:"suekawaeita"},
  {name:"ä¿é‡Œ ç‘›éƒ½(H.EITO)", img:"https://i.imgur.com/IAhs4ZA.png", id:"horieito"},
  {name:"é‡‘ç”° æ „éƒ½(K.EITO)", img:"https://i.imgur.com/tF7i1du.png", id:"kanedaeito"},
  {name:"æ«»äº• æ¥“çœŸ(FUMA)", img:"https://i.imgur.com/WIWI8Sx.png", id:"sakuraifuma"},
  {name:"å°ç¬ åŸã‚¸ãƒ¥ã‚¼ãƒƒãƒšæ…§(GIUSEPPE)", img:"https://i.imgur.com/2oKn3Ma.jpeg", id:"ogasawaragiuseppekei"},
  {name:"å€‰æ©‹ å¾æ§™(GOTEN)", img:"https://i.imgur.com/hlEjYqR.png", id:"kurahashigoten"},
  {name:"å €å°¾ è–(HIJIRI)", img:"https://i.imgur.com/5Qb5dRJ.png", id:"horiohijiri"},
  {name:"ç‘æ…¶è¦§ å¤ªéƒ½(HIROTO)", img:"https://i.imgur.com/siOPGIr.png", id:"zukeranhiroto"},
  {name:"ãƒ¦ãƒ»ãƒ’ãƒ§ãƒ³ã‚¹ãƒ³(HYEONSEUNG)", img:"https://i.imgur.com/lY3lXLj.png", id:"yoohyeonseung"},
  {name:"å²¡ç”° å½ªå¾(HYUGO)", img:"https://i.imgur.com/zalwc1W.png", id:"okadahyugo"},
  {name:"æŸ³è°· ä¼Šå†´(ISSA)", img:"https://i.imgur.com/gboCNWu.png", id:"yanagiyaissa"},
  {name:"ãƒ¦ãƒ³ãƒ»ã‚¸ã‚§ãƒ¨ãƒ³(JAEYONG)", img:"https://i.imgur.com/1yCImxd.png", id:"yoonjaeyong"},
  {name:"ã‚¸ãƒ¥ã‚¢ãƒ³ãƒ»ã‚¸ã‚§ã‚¤(JAY)", img:"https://i.imgur.com/41jKNZX.png", id:"chuangjay"},
  {name:"ä¸¸å°¾ å°‹ä¸€éƒ(JINICHIRO)", img:"https://i.imgur.com/83azYjx.png", id:"maruojinichiro"},
  {name:"æ²³é‚Š æ™Ÿ(JOE)", img:"https://i.imgur.com/DqUS1o6.png", id:"kawabejoe"},
  {name:"ã‚·ãƒ³ãƒ»ã‚¸ãƒ§ãƒ³ã‚¦ã‚¯(JUNGUK)", img:"https://i.imgur.com/6cwEusK.jpeg", id:"shinjunguk"},
  {name:"é‡‘å®‰ ç´”æ­£(JUNSEI)", img:"https://i.imgur.com/juPhMDR.png", id:"kaneyasujunsei"},
  {name:"å®‡é‡ æµ·å¤¢(KAIMU)", img:"https://i.imgur.com/QVliSyD.png", id:"unokaimu"},
  {name:"å¤šæ¯” å¥è–(KANADE)", img:"https://i.imgur.com/rdSJ6QX.png", id:"tabikanade"},
  {name:"æ¨ªå±± å¥å¤¢(KANAME)", img:"https://i.imgur.com/0brlEw8.png", id:"yokoyamakaname"},
  {name:"é–¢ æ•¬æ¬¡éƒ(KEIJIRO)", img:"https://i.imgur.com/PHlkDUt.png", id:"sekikeijiro"},
  {name:"é«™æ¾ æ•¬ç¥(KEISUKE)", img:"https://i.imgur.com/bs4vfiF.png", id:"takamatsukeisuke"},
  {name:"å°é‡ æ…¶äºº(KEITO)", img:"https://i.imgur.com/glfmRJE.png", id:"onokeito"},
  {name:"è¥¿å±± è³¢äºº(KENTO)", img:"https://i.imgur.com/izEXoBY.png", id:"nishiyamakento"},
  {name:"æ²³åˆ æ™ƒèª (KOSEI)", img:"https://i.imgur.com/E30eGfr.png", id:"kawaikosei"},
  {name:"ç…§äº• åº·ç¥(KOSUKE)", img:"https://i.imgur.com/oDkwdFn.png", id:"teruikosuke"},
  {name:"æµ…é¦™ å­å¤ªéƒ(KOTARO)", img:"https://i.imgur.com/7eJxl8o.png", id:"asakakotaro"},
  {name:"é«™è°· äº¬å¹³(KYOHEI)", img:"https://i.imgur.com/CLU1cPO.png", id:"takayakyohei"},
  {name:"ç”°ä¸­ è’”(MAKI)", img:"https://i.imgur.com/No6Nybr.png", id:"tanakamaki"},
  {name:"å±±æ ¹ æ­¦è”µ(MUSASHI)", img:"https://i.imgur.com/Ou2XuDa.png", id:"yamanemusashi"},
  {name:"åœŸç”° å¤®ä¿®(OSUKE)", img:"https://i.imgur.com/Xs0WjIn.png", id:"tsuchidaosuke"},
  {name:"å €é‡ è“®(H.REN)", img:"https://i.imgur.com/FQEx0JM.png", id:"horinoren"},
  {name:"å°æ¸…æ°´ è“®(KO.REN)", img:"https://i.imgur.com/S8Ij9OZ.png", id:"koshimizuren"},
  {name:"ãƒã‚§ãƒ³ãƒ»ãƒªãƒƒã‚­ãƒ¼(RICKEY)", img:"https://i.imgur.com/DnnZVAT.png", id:"chenrickey"},
  {name:"ç¥å…ƒ ç†ä¸˜(RIKU)", img:"https://i.imgur.com/jwJ9CLd.png", id:"kamimotoriku"},
  {name:"é³©å ´ é™¸äºº(H.RIKUTO)", img:"https://i.imgur.com/JdCFbCb.png", id:"hatobarikuto"},
  {name:"ä»Šæ±Ÿ é™¸æ–—(I.RIKUTO)", img:"https://i.imgur.com/jiZZwJu.png", id:"imaerikuto"},
  {name:"ç”²æ– é™¸ä¹Ÿ(RIKUYA)", img:"https://i.imgur.com/lfiqB2f.png", id:"kairikuya"},
  {name:"å¤§ç€¬ å‡œå’Œ(RINTO)", img:"https://i.imgur.com/OT0UHId.png", id:"ohserinto"},
  {name:"ä¸Šé‡ ç‰å‰(U.RUI)", img:"https://i.imgur.com/36XqMd9.png", id:"uenorui"},
  {name:"é£¯å¡š äº®è³€(RYOGA)", img:"https://i.imgur.com/ExbaI6W.png", id:"iizukaryoga"},
  {name:"çŸ³ç”° äº®å¤ª(RYOTA)", img:"https://i.imgur.com/Ctw95jF.png", id:"ishidaryota"},
  {name:"å²¡æˆ¸ ç«œèŠ½(RYUGA)", img:"https://i.imgur.com/gyPHKjY.png", id:"okadoryuga"},
  {name:"æ‰å±± ç«œå¸(RYUJI)", img:"https://i.imgur.com/NeB980M.png", id:"sugiyamaryuji"},
  {name:"é¦™æœˆ èª å¤ª(SEITA)", img:"https://i.imgur.com/def6F6u.png", id:"katsukiseita"},
  {name:"æ¾¤äº• æ˜Ÿå(SENA)", img:"https://i.imgur.com/Dpzzr9K.png", id:"sawaisena"},
  {name:"ã‚ªãƒ»ã‚·ãƒ³ãƒ˜ãƒ³(SHINHAENG)", img:"https://i.imgur.com/LH673dA.png", id:"ohshinhaeng"},
  {name:"å²©åŸ æ…äºŒ(SHINJI)", img:"https://i.imgur.com/h5rDvjC.png", id:"iwakishinji"},
  {name:"å®®å´ çœŸä½‘(SHINSUKE)", img:"https://i.imgur.com/xJuj9wW.png", id:"miyazakishinsuke"},
  {name:"è¥¿ï¨‘ æŸŠ(N.SHU)", img:"https://i.imgur.com/OZrHFUX.png", id:"nishizakishu"},
  {name:"å±±ä¸‹ æŸŠ(Y.SHU)", img:"https://i.imgur.com/642IX8o.png", id:"yamashitashu"},
  {name:"ãƒ‘ã‚¯ãƒ»ã‚·ãƒ¨ãƒ³(SIYOUNG)", img:"https://i.imgur.com/wSokxJh.png", id:"parksiyoung"},
  {name:"ä½è—¤ ç¢§ç©º (S.SORA)", img:"https://i.imgur.com/yF4WJJB.png", id:"satosora"},
  {name:"æ±é‡ è’¼æ±°(SOTA)", img:"https://i.imgur.com/GvLpwfo.png", id:"tonosota"},
  {name:"è—¤ç‰§ å¤§é›…(F.TAIGA)", img:"https://i.imgur.com/4G2hBRy.png", id:"fujimakitaiga"},
  {name:"æ¾ç”° å¤ªé›…(M.TAIGA)", img:"https://i.imgur.com/tICsJFs.png", id:"matsudataiga"},
  {name:"é‡‘å€‰ æ‹“æœª(TAKUMI)", img:"https://i.imgur.com/O3gluG7.png", id:"kanakuratakumi"},
  {name:"ç†Šéƒ¨ æ‹“æ–—(K.TAKUTO)", img:"https://i.imgur.com/NaQURc7.png", id:"kumabetakuto"},
  {name:"å®®é‡Œ æ‹“åˆ©(M.TAKUTO)", img:"https://i.imgur.com/5B8NMyF.png", id:"miyazatotakuto"},
  {name:"å—å¹³ é”çŸ¢(TATSUYA)", img:"https://i.imgur.com/jHnmGTs.png", id:"minamihiratatsuya"},
  {name:"æ£®äº• è¼(TERU)", img:"https://i.imgur.com/SAo1Rs4.png", id:"moriiteru"},
  {name:"åŒ—æ— å¤©è™(TETORA)", img:"https://i.imgur.com/2gCwqHF.png", id:"kitabayashitetora"},
  {name:"è—¤èŠ³ è¾°å¼¥(TOKIYA)", img:"https://i.imgur.com/9prpjvI.png", id:"fujiyoshitokiya"},
  {name:"å¢—ç”° å€«å¸Œ(TOMOKI)", img:"https://i.imgur.com/4JSh3HD.png", id:"masudatomoki"},
  {name:"æ¿±ç”° æ°¸é (TOWA)", img:"https://i.imgur.com/Yap9beM.png", id:"hamadatowa"},
  {name:"ã‚¢ã‚®ãƒŠãƒ«ãƒ‰ãƒ»ãƒˆãƒªã‚¹ã‚¿ãƒ³ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚¹(TRISTAN)", img:"https://i.imgur.com/wyeHbRo.png", id:"aguinaldotristanjames"},
  {name:"ãƒªãƒ¼ãƒ»ã‚¦ã‚§ã‚¤ã‚¼(WEIZE)", img:"https://i.imgur.com/XNeHaaX.png", id:"liweize"},
  {name:"ãƒ¨ãƒãƒ³ãƒ»ã‚¨ãƒãƒ‹ãƒ¥ã‚¨ãƒ«(YOHAN)", img:"https://i.imgur.com/RTVMTCA.png", id:"yohanemmanuel"},
  {name:"çŸ¢ç”° ä½³æš‰(YOSHIKI)", img:"https://i.imgur.com/MZbSVDq.png", id:"yadayoshiki"},
  {name:"å¾Œè—¤ çµ(YUKI)", img:"https://i.imgur.com/GZTdD57.png", id:"gotoyuki"},
  {name:"å²¡ç”° ä¾‘ç£¨(YUMA)", img:"https://i.imgur.com/3hhNQLj.png", id:"okadayuma"},
  {name:"å®‰éƒ¨ çµè˜­(YURA)", img:"https://i.imgur.com/pbC301p.png", id:"abeyura"},
  {name:"å¤§æ— æ‚ æˆ(O.YUSEI)", img:"https://i.imgur.com/tp1fKqI.png", id:"obayashiyusei"},
  {name:"ä½é‡ ç”±å¾(S.YUSEI)", img:"https://i.imgur.com/fDql5Tu.png", id:"sanoyusei"},
  {name:"æ¿å€‰ æ‚ å¤ª(YUTA)", img:"https://i.imgur.com/j6IlxeD.png", id:"itakurayuta"}
];

const candidates = [
  {name:"æœ¬è˜ æ™ƒ(AKIRA)", img:"https://i.imgur.com/p976l8j.jpeg", id:"honjoakira"},
  {name:"å…å³¶ æ­©å¤¢(K.AYUMU)", img:"https://i.imgur.com/1jtcgbB.png", id:"kojimaayumu"},
  {name:"å¸‚å· å¤§è¼(I.DAIKI)", img:"https://i.imgur.com/72FqxLz.png", id:"ichikawadaiki"},
  {name:"å·æ‘ ç€æ–—(HAKUTO)", img:"https://i.imgur.com/ua7RMig.png", id:"kawamurahakuto"},
  {name:"æ‘æ¾ é¼ç©º(HARUKU)", img:"https://i.imgur.com/3JEtKs6.png", id:"muramatsuharuku"},
  {name:"é«™åŸ æš–äºº(HARUTO)", img:"https://i.imgur.com/qdXIOpr.png", id:"takagiharuto"},
  {name:"å¹³å³¶ è¼(H.HIKARU)", img:"https://i.imgur.com/P5gzRZh.png", id:"hirashimahikaru"},
  {name:"æ«»äº• è¼(S.HIKARU)", img:"https://i.imgur.com/h2fBMUv.png", id:"sakuraihikaru"},
  {name:"ä½å· å¤ªä¸€(HIROKAZU)", img:"https://i.imgur.com/h2fBMUv.png", id:"sagawahirokazu"},
  {name:"ã‚¤ãƒ»ãƒ’ãƒ§ãƒ³ã‚¸ã‚§(HYUNJAE)", img:"https://i.imgur.com/wOhvKDu.png", id:"leehyunjae"},
  {name:"é˜¿éƒ¨ æ¨¹(ITSUKI)", img:"https://i.imgur.com/TaTAc2L.png", id:"abeitsuki"},
  {name:"ã‚¤ãƒ»ã‚¸ãƒ¥ãƒ³ãƒ•ãƒ³(JOONGHOON)", img:"https://i.imgur.com/4utwyOJ.png", id:"leejoonghoon"},
  {name:"ãƒªãƒ¥ã‚¦ãƒ»ã‚«ã‚¤ãƒ(KAICHI)", img:"https://i.imgur.com/FGbdGcI.png", id:"liukaichi"},
  {name:"é»’ï¨‘ è²«æ±°(KANTA)", img:"https://i.imgur.com/j75eoO7.png", id:"kurosakikanta"},
  {name:"é»„ æ•¬çœ(KEISHIN)", img:"https://i.imgur.com/oE7w4D7.png", id:"kokeishin"},
  {name:"é‡¼æŒ å‰æˆ(KINARI)", img:"https://i.imgur.com/GWAtiwS.png", id:"kenmotsukinari"},
  {name:"å°æ¾¤ æ˜‚å¿ƒ(KOSHIN)", img:"https://i.imgur.com/pn0zB7F.png", id:"ozawakoshin"},
  {name:"é’æ²¼ æ˜‚å²æœ—(KOSHIRO)", img:"https://i.imgur.com/MDhTcs8.png", id:"aonumakoshiro"},
  {name:"å°æ— å»£(KOU)", img:"https://i.imgur.com/RAoUIhC.png", id:"kobayashikou"},
  {name:"æ£® æ˜è‚²(MEI)", img:"https://i.imgur.com/eR0BZVs.png", id:"morimei"},
  {name:"ãƒã‚¤ã‚±ãƒ« ãƒŸãƒ³ãƒ»ãƒã‚«ãƒ•ãƒª(MICHAEL MINH)", img:"https://i.imgur.com/6S8BWAA.png", id:"michaelminhmccaffrey"},
  {name:"ãƒ‘ãƒˆãƒªãƒƒã‚¯ ãƒ•ã‚¡ãƒ³ãƒ»ãƒ¬(PATRICK)", img:"https://i.imgur.com/YRvJQYc.png", id:"patrickphanle"},
  {name:"ç¬ åŸ è“®(KA.REN)", img:"https://i.imgur.com/ZLgNm7o.png", id:"kasahararen"},
  {name:"æ±Ÿå£ è“®ç¿”(E.RENTO)", img:"https://i.imgur.com/ewXd8NH.png", id:"eguchirento"},
  {name:"å°æ— è“®ç¿”(K.RENTO)", img:"https://i.imgur.com/t2NbxIU.png", id:"kobayashirento"},
  {name:"è½åˆ åˆ©æ¸©(RIO)", img:"https://i.imgur.com/HdTZUdu.png", id:"ochiairio"},
  {name:"æ°´ä¸Š ç‰å‰(M.RUI)", img:"https://i.imgur.com/DiUA9bw.png", id:"mizugamirui"},
  {name:"å°è°·å†… ç‘ å˜‰(RUKA)", img:"https://i.imgur.com/V2XnsQ6.png", id:"koyauchiruka"},
  {name:"é½Šè—¤ æƒº(SEI)", img:"https://i.imgur.com/9HIRvNd.png", id:"saitosei"},
  {name:"è—¤æœ¬ çœŸæˆ(SHINSEI)", img:"https://i.imgur.com/qTooOuS.png", id:"fujimotoshinsei"},
  {name:"é£¯ç”° æŸŠé¦¬(SHUMA)", img:"https://i.imgur.com/awBBn6j.png", id:"iidashuma"},
  {name:"æ¾ç”° é¢¯å¾(SOGO)", img:"https://i.imgur.com/Y1MQK3k.png", id:"matsudasogo"},
  {name:"é«™æ©‹ ç©ºè‰¯(T.SORA)", img:"https://i.imgur.com/czFpgjm.png", id:"takahashisora"},
  {name:"è¥¿ç”° é¢¯æ¢“(SOSHI)", img:"https://i.imgur.com/51RMIB6.png", id:"nishidasoshi"},
  {name:"å²¡æœ¬ æ‹“å£«(O.TAKUTO)", img:"https://i.imgur.com/TGP6sbe.png", id:"okamototakuto"},
  {name:"å¤§æ¾¤ ä½‘å†´(YUGO)", img:"https://i.imgur.com/5Gg1E1M.png", id:"osawayugo"},
  {name:"è—¤äº• é›„è–(F.YUSEI)", img:"https://i.imgur.com/prsNOtG.png", id:"fujiiyusei"},
  {name:"å²¡æœ¬ ä½‘æ–—(YUTO)", img:"https://i.imgur.com/lzv8Vu5.png", id:"okamotoyuto"}
];

const trainees = traineesOnly.concat(candidates);
const TRAINEES_COUNT = traineesOnly.length;

let selected = loadSelected();

/* ãƒãƒŠãƒ¼ç”»åƒåæ˜  */
(function setupBanners(){
  const banner = document.getElementById("banner");
  if(HEADER_IMAGE_URL){
    banner.classList.add("hasImage");
    banner.style.backgroundImage = "url('" + HEADER_IMAGE_URL + "')";
  }
})();

/* ===== UIæç”» ===== */
function drawPicks(){
  const row = document.getElementById("picksRow");
  row.innerHTML = "";

  for(let i=0; i<MAX_PICK; i++){
    const slot = document.createElement("div");

    if(i < selected.length){
      const m = trainees[selected[i]];
      slot.className = "slot";
      slot.innerHTML = `
        <div class="avatar">
          <img src="${m.img || FALLBACK_IMG}" alt="">
          <div class="rank">${i + 1}</div>
        </div>
        <div class="name">${displayName(m.name)}</div>
        <div class="reorder">
          <button type="button" onclick="moveLeft(${i})">â†</button>
          <button type="button" onclick="moveRight(${i})">â†’</button>
        </div>
      `;
    }else{
      slot.className = "slot empty";
      slot.innerHTML = `<div class="avatar">+</div>`;
    }
    row.appendChild(slot);
  }
}

function drawMembers(){
  const q = (document.getElementById("search").value || "").trim().toLowerCase();
  const membersEl = document.getElementById("members");
  membersEl.innerHTML = "";

  const start = showingCandidates ? TRAINEES_COUNT : 0;
  const end   = showingCandidates ? trainees.length : TRAINEES_COUNT;

  for(let i=start; i<end; i++){
    const m = trainees[i];
    if(q && (m.name||"").toLowerCase().indexOf(q) === -1) continue;

    const card = document.createElement("div");
    card.className = "memberCard" + (selected.indexOf(i) !== -1 ? " selected" : "");
    const purl = profileUrlById(m.id);

    card.innerHTML = `
      <div class="memberCardThumb"><img src="${m.img || FALLBACK_IMG}" alt=""></div>
      <div class="memberCardName">${displayName(m.name)}</div>
      <div class="memberCardSub">${alphaPart(m.name)}</div>
      <a class="memberCardProfile" href="${purl}" target="_blank" rel="noopener" onclick="event.stopPropagation()">profile</a>
    `;
    card.addEventListener("click", () => add(i));
    membersEl.appendChild(card);
  }
}

function toggleCandidates(e){
  if(e && e.preventDefault) e.preventDefault();
  showingCandidates = !showingCandidates;
  document.getElementById("toggleListBtn").textContent = showingCandidates ? "ç·´ç¿’ç”Ÿ" : "ç·´ç¿’ç”Ÿå€™è£œ";
  drawMembers();
}

/* é¸æŠæ“ä½œ */
function add(i){
  if(selected.length >= MAX_PICK){ alert("11äººã¡ã‚‡ã†ã©é¸ã‚“ã§ãã ã•ã„"); return; }
  if(selected.indexOf(i) !== -1) return;
  selected.push(i);
  saveSelected();
  drawPicks();
  drawMembers();
}
function undo(){
  selected.pop();
  saveSelected();
  drawPicks();
  drawMembers();
}
function resetAll(){
  selected = [];
  saveSelected();
  drawPicks();
  drawMembers();
}

/* ä¸¦ã³æ›¿ãˆ */
let reorderMode = false;
function toggleReorder(){
  reorderMode = !reorderMode;
  document.body.classList.toggle("reorder-on", reorderMode);
  document.getElementById("reorderBtn").textContent = "ä¸¦ã³æ›¿ãˆãƒ¢ãƒ¼ãƒ‰ï¼š" + (reorderMode ? "ON" : "OFF");
}
function swap(a,b){
  if(a<0||b<0||a>=selected.length||b>=selected.length) return;
  const t = selected[a]; selected[a]=selected[b]; selected[b]=t;
  saveSelected();
  drawPicks(); drawMembers();
}
function moveLeft(pos){ swap(pos, pos-1); }
function moveRight(pos){ swap(pos, pos+1); }

function saveSelected(){
  try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(selected)); }catch(e){}
}
function loadSelected(){
  try{
    const raw = localStorage.getItem(STORAGE_KEY);
    const arr = raw ? JSON.parse(raw) : [];
    return Array.isArray(arr) ? arr.filter(n => Number.isInteger(n)) : [];
  }catch(e){ return []; }
}

/* ===== Supabaseï¼šåŒ¿åãƒ­ã‚°ã‚¤ãƒ³ ===== */
async function ensureAuth(){
  const { data: { session } } = await window.sb.auth.getSession();
  if(session) return;
  const { error } = await window.sb.auth.signInAnonymously();
  if(error) throw error;
}

/* ===== æŠ•ç¥¨ï¼ˆEdge FunctionçµŒç”±ï¼‰ ===== */
async function submitVote(){
  // â˜…11äººã¡ã‚‡ã†ã©å¿…é ˆ
  if(selected.length !== 11){
    alert("11äººã¡ã‚‡ã†ã©é¸ã‚“ã§ã‹ã‚‰æŠ•ç¥¨ã—ã¦ãã ã•ã„");
    return;
  }

  // Turnstile token
  const turnstileToken = window.turnstile?.getResponse?.();
  if(!turnstileToken){
    alert("CAPTCHAã‚’å®Œäº†ã—ã¦ãã ã•ã„");
    return;
  }

  // trainee idsï¼ˆé‡è¤‡é™¤å»ã—ã¦ 11 ã¡ã‚‡ã†ã©ï¼‰
  const ids = selected.map(idx => trainees[idx]?.id).filter(Boolean);
  const unique = Array.from(new Set(ids));
  if(unique.length !== 11){
    alert("åŒã˜ãƒ¡ãƒ³ãƒãƒ¼ã‚’é‡è¤‡ã—ã¦é¸ã‚“ã§ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼ˆ11äººã¡ã‚‡ã†ã©ã«ã—ã¦ãã ã•ã„ï¼‰");
    return;
  }

  const toast = document.getElementById("toast");
  toast.style.display = "block";
  toast.textContent = "æŠ•ç¥¨ä¸­â€¦";

  try{
    await ensureAuth();
    const { data: { session } } = await window.sb.auth.getSession();
    const accessToken = session?.access_token;
    if(!accessToken) throw new Error("ãƒ­ã‚°ã‚¤ãƒ³ã«å¤±æ•—ã—ã¾ã—ãŸ");

    const cfg = window.__CFG;
    const res = await fetch(`${cfg.FUNCTIONS_URL}/quick-worker`, {
      method: "POST",
      headers: {
  "Content-Type": "application/json",
  "apikey": cfg.SUPABASE_ANON_KEY,
  "Authorization": `Bearer ${accessToken}`,
},
      body: JSON.stringify({
        trainee_ids: unique,
        turnstile_token: turnstileToken,
      })
    });

    const out = await res.json().catch(()=>({}));
    if(!res.ok){
      if(out?.error === "already_voted_today"){
        alert("ä»Šæ—¥ã¯ã™ã§ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™ï¼ˆKST ê¸°ì¤€ã§1æ—¥1å›ï¼‰");
      }else if(out?.error === "captcha_failed"){
        alert("CAPTCHAã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„");
        window.turnstile?.reset?.();
      }else{
        alert("æŠ•ç¥¨ã‚¨ãƒ©ãƒ¼ï¼š" + (out?.details || out?.error || res.status));
      }
      return;
    }

    // æˆåŠŸæ¼”å‡º
    showVoteSuccessPop();
    window.turnstile?.reset?.();

    // åæ˜ ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°æ›´æ–°
    await refreshRankings();
  }catch(e){
    alert("æŠ•ç¥¨ã«å¤±æ•—ã—ã¾ã—ãŸï¼š" + (e?.message || e));
  }finally{
    toast.style.display = "none";
  }
}

/* ===== èª•ç”Ÿæ—¥è¡¨ç¤ºï¼ˆç·´ç¿’ç”Ÿï¼‹å€™è£œï¼‰ ===== */
async function refreshBirthdays(){
  const md = kstMonthDay(); // MM-DD
  const todays = trainees.filter(m => (BIRTHDAYS[m.id] || "") === md);

  const wrap = document.getElementById("birthdayWrap");
  const empty = document.getElementById("birthdayEmpty");
  wrap.innerHTML = "";

  if(todays.length === 0){
    empty.style.display = "block";
    return;
  }
  empty.style.display = "none";

  todays.forEach(m=>{
    const el = document.createElement("div");
    el.className = "pill";
    el.innerHTML = `
      <img src="${m.img}" style="width:34px;height:34px;border-radius:999px;object-fit:cover;border:1px solid #eee;">
      <span>${displayName(m.name)}</span>
    `;
    wrap.appendChild(el);
  });
}

/* ===== ä»Šæ—¥ã®é‹å‹¢ï¼ˆAIç”Ÿæˆæ¸ˆã¿ã‚’DBã‹ã‚‰èª­ã‚€ï¼‰ ===== */
async function refreshFortune(){
  const date = kstDateKey();
  document.getElementById("fortuneDate").textContent = date;

  // DBã«ãã®æ—¥åˆ†ãŒã¾ã ç„¡ã„å¯èƒ½æ€§ã‚‚ã‚ã‚‹ã®ã§ã€Œç”Ÿæˆä¸­ã€è¡¨ç¤ºã«ã—ã¦ãŠã
  const mbtiList = document.getElementById("mbtiList");
  const zodiacList = document.getElementById("zodiacList");
  const commentEl = document.getElementById("fortuneComment");
  mbtiList.innerHTML = "";
  zodiacList.innerHTML = "";
  commentEl.textContent = "ç”Ÿæˆä¸­â€¦";

  try{
    await ensureAuth();

    // ä¾‹ï¼šdaily_fortunes ã®åˆ—æƒ³å®š:
    // date (text or date) / mbti_top3 (text[]) / zodiac_top3 (text[]) / comment (text)
    const { data, error } = await window.sb
      .from(FORTUNE_TABLE)
      .select("*")
      .eq("date", date)
      .maybeSingle();

    if(error) throw error;
    if(!data){
      commentEl.textContent = "ç”Ÿæˆä¸­â€¦ï¼ˆ0:00ç›´å¾Œã¯å°‘ã—é…ã‚Œã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ï¼‰";
      return;
    }

    const mbti = Array.isArray(data.mbti_top3) ? data.mbti_top3 : [];
    const zod = Array.isArray(data.zodiac_top3) ? data.zodiac_top3 : [];
    const comment = data.comment || "â€”";

    mbtiList.innerHTML = mbti.slice(0,3).map(x=>`<span class="tag">${x}</span>`).join("");
    zodiacList.innerHTML = zod.slice(0,3).map(x=>`<span class="tag">${x}</span>`).join("");
    commentEl.textContent = comment;

  }catch(e){
    commentEl.textContent = "é‹å‹¢ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ";
  }
}

/* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆå…¨å“¡è¡¨ç¤ºãƒ»0ç¥¨è£œå®Œï¼‰ ===== */
function setRankingMode(mode){
  rankingMode = mode === "total" ? "total" : "daily";
  refreshRankings();
}

function buildAllWithZero(countRows){
  const counts = new Map();
  (countRows || []).forEach(r=>{
    counts.set(r.trainee_id, Number(r.votes || 0));
  });

  const all = trainees.map(m => ({
    trainee_id: m.id,
    name: m.name,
    img_url: m.img,
    votes: counts.get(m.id) ?? 0
  }));

  all.sort((a,b)=>{
    if(b.votes !== a.votes) return b.votes - a.votes;
    return String(a.name).localeCompare(String(b.name), "ja");
  });

  return all;
}

function renderRankingAll(rows, title){
  const wrap = document.getElementById("rankWrap");
  wrap.innerHTML = `
    <div style="font-weight:1000; margin:0 0 10px;">${title}</div>
    <div style="display:flex; flex-direction:column; gap:8px;">
      ${rows.map((r,i)=>`
        <div class="rankRow">
          <div class="rankNum">${i+1}</div>
          <img class="rankImg" src="${r.img_url}" alt="">
          <div class="rankName">${displayName(r.name)}</div>
          <div class="rankVotes">${r.votes}</div>
        </div>
      `).join("")}
    </div>
  `;
}

async function refreshRankings(){
  const wrap = document.getElementById("rankWrap");
  wrap.innerHTML = `<div style="font-weight:900;color:#666;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ä¸­â€¦</div>`;

  try{
    await ensureAuth();

    if(rankingMode === "daily"){
      const { data, error } = await window.sb.rpc("get_daily_ranking", { p_date: null });
      if(error) throw error;
      const all = buildAllWithZero(data || []);
      renderRankingAll(all, "ä»Šæ—¥ã®ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆKSTï¼‰");
    }else{
      const { data, error } = await window.sb.rpc("get_total_ranking");
      if(error) throw error;
      const all = buildAllWithZero(data || []);
      renderRankingAll(all, "ç´¯è¨ˆãƒ©ãƒ³ã‚­ãƒ³ã‚°");
    }
  }catch(e){
    wrap.innerHTML = `<div style="font-weight:900;color:#b30000;">ãƒ©ãƒ³ã‚­ãƒ³ã‚°å–å¾—ã«å¤±æ•—ï¼š${e?.message || e}</div>`;
  }
}

/* åˆæœŸåŒ– */
(async function initAll(){
  drawPicks();
  drawMembers();
  await refreshBirthdays();
  await refreshFortune();
  await refreshRankings();
  scheduleDailyAutoRefresh();
})();
</script>
</body>
</html>
