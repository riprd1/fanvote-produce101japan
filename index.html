<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>æŠ•ç¥¨ï¼ˆ11äººï¼‰</title>
  <style>
    :root{
      --bd:#e6e6e6;
      --bg:#fafafa;
      --txt:#111;
      --sub:#666;
      --pill:#f2f2f2;
    }
    body{
      font-family: system-ui, -apple-system, sans-serif;
      margin: 0;
      color: var(--txt);
      background: #fff;
    }

    /* ===== ãƒ˜ãƒƒãƒ€ãƒ¼ç”»åƒ ===== */
    .header{
      width: 100%;
      height: 110px;
      background-image: url("https://i.imgur.com/wJy5Wb5.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* ===== å³ä¸Šï¼šç”»é¢åˆ‡æ›¿ãƒœã‚¿ãƒ³ ===== */
    .topNav{
      position: sticky;
      top: 0;
      z-index: 50;
      background: rgba(255,255,255,.92);
      backdrop-filter: blur(8px);
      border-bottom: 1px solid var(--bd);
    }
    .topNavInner{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:10px 12px;
    }
    .brand{
      font-weight: 900;
      font-size: 13px;
      color: var(--sub);
      white-space: nowrap;
    }
    .navBtns{
      display:flex;
      gap:8px;
      align-items:center;
    }
    .navBtn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--bd);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
    }
    .navBtn.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    .page{
      padding: 16px;
    }

    h1{font-size:18px;margin:12px 0 10px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      padding:10px 12px;border:1px solid var(--bd);
      border-radius:12px;background:#fff;font-weight:800;cursor:pointer;
    }
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    input[type="text"]{
      padding:10px 12px;border:1px solid var(--bd);
      border-radius:12px;min-width:180px;flex:1;
    }
    .sub{color:var(--sub);font-size:12px}

    /* ===== TikTokãƒœã‚¿ãƒ³ï¼ˆè¿½åŠ ï¼‰ ===== */
    .tiktokBtn{
      display: inline-flex;
      align-items: center;
      justify-content: center;
      margin-left: 10px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(0,0,0,.15);
      background: rgba(255,255,255,.9);
      color: #111;
      font-weight: 900;
      font-size: 12px;
      text-decoration: none;
      line-height: 1;
    }
    .tiktokBtn:active{ transform: translateY(1px); }

    /* ===== Xã‚·ã‚§ã‚¢ï¼ˆæ—¢å­˜ãƒ»ä»Šå›ã¯åŸºæœ¬éè¡¨ç¤ºï¼‰ ===== */
    .shareRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:wrap;
    }
    .xShareBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--bd);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      text-decoration:none;
      color:#111;
      line-height: 1;
    }
    .xShareBtn:active{ transform: translateY(1px); }

    /* ===== ç”»é¢åˆ‡æ›¿ ===== */
    .view{ display:none; }
    .view.active{ display:block; }

    /* ===== ä¸Šï¼šé¸æŠ11äºº ===== */
    .selectedWrap{
      border:1px solid var(--bd);
      border-radius:16px;
      padding:12px;
      background: var(--bg);
    }
    .selectedTitle{
      font-weight:900;
      font-size:13px;
      margin:0 0 8px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .selectedCount{font-weight:900}

    .slots{
      display:flex;
      gap:12px;
      overflow-x:auto;
      padding:6px 2px 10px;
      -webkit-overflow-scrolling: touch;
    }
    .slot{
      flex:0 0 auto;
      width:74px;
      height:74px;
      border-radius:18px;
      border:2px dashed #cfcfcf;
      background:#fff;
      display:grid;
      place-items:center;
      color:#9a9a9a;
      font-weight:900;
      position:relative;
      user-select:none;
      -webkit-user-select:none;
      touch-action: pan-x;
    }
    .slot.filled{
      border-style:solid;
      border-color:#dedede;
      padding:0;
      overflow:hidden;
      cursor: pointer;
    }
    .slot img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#f2f2f2;
    }

    /* ===== ä¸€è¦§ã‚¨ãƒªã‚¢ï¼ˆèƒŒæ™¯ç”»åƒã¤ãï¼‰ ===== */
    .listHeader{
      margin-top:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .listHeader h2{
      margin:0;
      font-size:14px;
      font-weight:900;
    }
    .controlsRow{
      margin-top:10px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .stickyControls{
      position: sticky;
      top: 56px;
      z-index: 30;
      background: rgba(255,255,255,.95);
      backdrop-filter: blur(6px);
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }

    .controlsRow input[type="text"]{
      flex: 1;
      min-width: 0;
    }
    .togglePill{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--bd);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      white-space:nowrap;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .togglePill .dot{
      width:10px;height:10px;border-radius:999px;background:#111;opacity:.25;
    }
    .togglePill.on .dot{ opacity:1; }

    .listSection{
      margin-top: 14px;
      border-radius: 18px;
      overflow: visible;
      background-image: url("https://i.imgur.com/eTuwSDL.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      padding: 14px;
      border: 1px solid var(--bd);
    }
    .listSection .overlay{
      background: rgba(255,255,255,.82);
      border-radius: 16px;
      padding: 12px;
    }

    .grid{
      margin-top:10px;
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap:14px;
    }
    .card{
      position: relative;
      border:1px solid var(--bd);
      border-radius:18px;
      padding:12px;
      background:#fff;
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .avatar{
      width:100%;
      aspect-ratio: 4 / 5;
      height:auto;
      border-radius:16px;
      overflow:hidden;
      background:#f2f2f2;
      position:relative;
    }
    .avatar img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }

    .profileBtn{
      position:absolute;
      top:10px;
      right:10px;
      padding:6px 12px;
      border-radius:999px;
      border:2px solid rgba(100,150,255,.35);
      background:rgba(255,255,255,.85);
      color:#2f6fe8;
      font-weight:900;
      font-size:12px;
      text-decoration:none;
      backdrop-filter: blur(6px);
    }

    .info{min-width:0;text-align:center}
    .name{
      font-weight:900;
      font-size:14px;
      line-height:1.25;
      word-break:break-word;
    }
    .meta{font-size:12px;color:var(--sub);margin-top:4px}

    .picked{
      opacity: .45;
      filter: grayscale(1);
      outline: 2px solid rgba(0,0,0,.08);
      pointer-events: none;
    }
    .picked .profileBtn{
      pointer-events: auto;
      opacity: 1;
      filter: none;
    }

    /* =========================
       â˜… è¾é€€è€…ï¼ˆè¿½åŠ ï¼‰
       - è¡¨ç¤ºã¯ã™ã‚‹ãŒã€ã‚°ãƒ¬ãƒ¼ï¼†é¸æŠä¸å¯
    ========================== */
    .withdrawn{
      opacity: .35;
      filter: grayscale(1);
      outline: 2px solid rgba(0,0,0,.06);
      pointer-events: none;
    }
    .withdrawn .profileBtn{
      pointer-events: auto;
      opacity: 1;
      filter: none;
    }
    .withdrawn .avatar::after{
      content: "â€»è¾é€€";
      position: absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 1000;
      font-size: 16px;
      color:#d00;
      background: rgba(255,255,255,.55);
    }

    @media (max-width: 340px){
      .grid{grid-template-columns: 1fr;}
    }

    /* ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ ===== */
    .rankPage{
      padding: 16px;
    }
    .rankCard{
      border:1px solid var(--bd);
      border-radius:16px;
      background: #fff;
      overflow: hidden;
    }
    .rankHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px;
      background: var(--bg);
      border-bottom:1px solid var(--bd);
    }
    .rankHead h2{
      margin:0;
      font-size:14px;
      font-weight:900;
    }
    .rankMeta{
      font-size:12px;
      color: var(--sub);
      white-space:nowrap;
    }
    .rankBody{
      padding: 10px 12px 12px;
    }

    .rankStatusRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin: 0 0 8px;
    }
    .rankStatus{
      font-size:12px;
      color: var(--sub);
      margin:0;
      white-space:nowrap;
    }
    .rankHint{
      font-size:12px;
      color: var(--sub);
      margin:0;
      text-align:right;
      white-space:nowrap;
    }

    .rankTable{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
    }
    .rankTable th, .rankTable td{
      padding: 10px 6px;
      border-bottom: 1px solid #f0f0f0;
      vertical-align: middle;
    }
    .rankTable th{
      text-align:left;
      color: var(--sub);
      font-weight:800;
      font-size:12px;
    }
    .rankNum{ width:44px; font-weight:900; }

    .rankVotes{
      width:88px;
      text-align:right;
      font-variant-numeric: tabular-nums;
      font-weight:900;
      white-space:nowrap;
    }

    .rankLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .rankThumbLink{
      display:inline-flex;
      width:44px;
      height:44px;
      border-radius:12px;
      overflow:hidden;
      flex:0 0 auto;
      border:1px solid rgba(0,0,0,.08);
      background:#f2f2f2;
      text-decoration:none;
    }
    .rankThumb{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .rankName{
      font-weight:900;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    #rankOpenSheet{ display:none; }

    /* =========================
       â˜… æŠ•ç¥¨å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«
    ========================== */
    .modalOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 18px;
    }
    .modalOverlay.open{ display:flex; }

    .modalCard{
      width: min(420px, 100%);
      border-radius: 18px;
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 12px 40px rgba(0,0,0,.18);
      overflow: hidden;
    }
    .modalHead{
      padding: 14px 14px 10px;
      background: var(--bg);
      border-bottom: 1px solid var(--bd);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .modalTitle{
      font-weight: 1000;
      font-size: 14px;
      margin: 0;
    }
    .modalCloseX{
      border: 1px solid var(--bd);
      background:#fff;
      border-radius: 999px;
      width: 34px;
      height: 34px;
      cursor: pointer;
      font-weight: 1000;
      line-height: 1;
    }
    .modalBody{
      padding: 14px;
    }
    .modalMsg{
      margin: 0 0 12px;
      font-weight: 900;
      font-size: 14px;
    }
    .modalSub{
      margin: 0 0 14px;
      color: var(--sub);
      font-size: 12px;
      line-height: 1.5;
    }
    .modalActions{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
    }
    .modalBtn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--bd);
      background:#fff;
      font-weight: 1000;
      cursor:pointer;
      text-decoration:none;
      color:#111;
      line-height:1;
    }
    .modalBtn.primary{
      background:#111;
      color:#fff;
      border-color:#111;
    }

    /* =========================
       â˜… ãƒã‚¤æŠ•ç¥¨ï¼ˆè¿½åŠ ï¼‰
    ========================== */
    .myBox{
      border:1px solid var(--bd);
      border-radius:16px;
      background:#fff;
      padding:10px;
      margin: 0 0 10px;
    }
    .myBtns{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }
    .myBtn{
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--bd);
      background:#fff;
      font-weight:900;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      line-height:1;
    }
    .myBtn.active{
      background:#111;
      color:#fff;
      border-color:#111;
    }
    .myPanel{
      margin-top:10px;
      border-top:1px solid #f0f0f0;
      padding-top:10px;
      display:none;
    }
    .myPanel.active{ display:block; }

    .myGrid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
    }
    .myItem{
      border:1px solid #f1f1f1;
      border-radius:14px;
      padding:8px;
      background:#fff;
    }
    .myThumb{
      width:100%;
      aspect-ratio: 1 / 1;
      border-radius:12px;
      overflow:hidden;
      background:#f2f2f2;
      border:1px solid rgba(0,0,0,.06);
    }
    .myThumb img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
    }
    .myName{
      margin-top:6px;
      font-weight:900;
      font-size:12px;
      line-height:1.2;
      word-break:break-word;
    }
    .myCount{
      margin-top:4px;
      font-size:12px;
      color: var(--sub);
      font-weight:900;
    }
    .myTop3{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:10px;
      margin-bottom:10px;
    }
    .myRankBadge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;
      height:22px;
      border-radius:999px;
      border:1px solid rgba(0,0,0,.12);
      font-weight:1000;
      font-size:12px;
      background:#fff;
    }
    .myNote{
      margin-top:10px;
      font-size:12px;
      color: var(--sub);
      line-height:1.5;
    }

    /* =========================
       â˜… åˆå›è¨ªå•ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆè¿½åŠ ï¼‰
    ========================== */
    .welcomeOverlay{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 10000;
      padding: 20px;
    }
    .welcomeCard{
      width: min(420px, 100%);
      background: #fff;
      border-radius: 20px;
      padding: 20px;
      position: relative;
      box-shadow: 0 20px 60px rgba(0,0,0,.25);
      border: 1px solid rgba(0,0,0,.08);
    }
    .welcomeTitle{
      font-weight: 1000;
      font-size: 16px;
      margin-bottom: 12px;
    }
    .welcomeText{
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
    }
    .welcomeBtn{
  display: flex;
  align-items: center;
  justify-content: center;

  width: min(220px, 75%);
  margin: 0 auto;

  padding: 10px 12px;
  border-radius: 14px;
  background: #111;
  color: #fff;
  font-weight: 1000;
  text-decoration: none;
  line-height: 1;
  font-size: 14px;
}
    .welcomeClose{
      position: absolute;
      bottom: 12px;
      right: 12px;
      font-size: 12px;
      border: none;
      background: none;
      color: #666;
      cursor: pointer;
      font-weight: 900;
    }
  </style>
</head>

<body>

  <div style="max-width:800px; margin:40px auto; line-height:1.8; padding:0 20px;">
    <h2>æ—¥ãƒ—æ–°ä¸–ç•Œ éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆ</h2>
    <p>
    å½“ã‚µã‚¤ãƒˆã¯ã€PRODUCE 101 JAPAN æ–°ä¸–ç•Œã‚’å¿œæ´ã™ã‚‹éå…¬å¼ãƒ•ã‚¡ãƒ³ã‚µã‚¤ãƒˆã§ã™ã€‚
    ç·´ç¿’ç”Ÿã®æƒ…å ±ã¾ã¨ã‚ã€ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã€æŠ•ç¥¨ãƒšãƒ¼ã‚¸ã¸ã®ãƒªãƒ³ã‚¯é›†ã‚’æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚
    </p>
    <p>
    ãƒ•ã‚¡ãƒ³åŒå£«ãŒæ¥½ã—ã‚ã‚‹å ´ã‚’ç›®æŒ‡ã—ã¦é‹å–¶ã—ã¦ã„ã¾ã™ã€‚
    </p>
  </div>

  <div class="header"></div>

  <!-- å³ä¸Šï¼šåˆ‡æ›¿ãƒœã‚¿ãƒ³ -->
  <div class="topNav">
    <div class="topNavInner">
      <div class="brand">PRODUCE 101 / éå…¬å¼ãƒ•ã‚¡ãƒ³æŠ•ç¥¨</div>
      <div class="navBtns">
        <button id="btnVote" class="navBtn active" type="button">æŠ•ç¥¨</button>
        <button id="btnRank" class="navBtn" type="button">ãƒ©ãƒ³ã‚­ãƒ³ã‚°</button>
      </div>
    </div>
  </div>

  <!-- ===== æŠ•ç¥¨ç”»é¢ ===== -->
  <div id="voteView" class="view active">
    <div class="page">
      <h1>æŠ•ç¥¨ï¼ˆ1å›ã§11äººé¸æŠï¼‰</h1>

      <div class="selectedWrap">
        <div class="selectedTitle">
          <span>é¸æŠä¸­</span>
          <span class="selectedCount"><span id="count">0</span>/11</span>
        </div>
        <div class="slots" id="slots"></div>

        <div class="row" style="margin-top:10px;">
          <button id="clearBtn" class="btn">ãƒªã‚»ãƒƒãƒˆ</button>
          <button id="undoBtn" class="btn">1äººæˆ»ã™</button>
          <button id="voteBtn" class="btn primary" disabled>11äººé¸ã‚“ã§æŠ•ç¥¨</button>
        </div>

        <!-- ï¼ˆæ—§ï¼‰Xã‚·ã‚§ã‚¢æ¬„ï¼šæ®‹ã—ã¦ã‚ã‚‹ã‘ã©ã€åŸºæœ¬ã¯ä½¿ã‚ãªã„ -->
        <div id="shareWrap" class="shareRow" style="display:none;">
          <a id="xShareBtn" class="xShareBtn" href="#" target="_blank" rel="noopener noreferrer">Xã§ã‚·ã‚§ã‚¢</a>
          <span class="sub">â€»æŠ¼ã™ã¨Xã®æŠ•ç¨¿ç”»é¢ãŒé–‹ãã¾ã™</span>
        </div>

        <div class="sub" style="margin-top:6px;">
          â€»ä¸Šã®é¡”ã‚’ã‚¿ãƒƒãƒ—ã§å‰Šé™¤ã§ãã¾ã™<br>
          â€»æŠ•ç¥¨æ¨©ã¯æ—¥æœ¬æ™‚é–“0:00ã«ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã™<br>
          <span style="color:#d00; font-weight:900;">
            â€»æœ¬ãƒšãƒ¼ã‚¸ã¯éå…¬å¼ï¼ˆãƒ•ã‚¡ãƒ³ãƒ¡ã‚¤ãƒ‰ï¼‰ã§ã‚ã‚Š<br>
            ç•ªçµ„ãƒ»é‹å–¶ãƒ»å…¬å¼æŠ•ç¥¨ã¨ã¯ç„¡é–¢ä¿‚ã§ã™ã€‚
            <a class="tiktokBtn" href="https://www.tiktok.com/@12agassi" target="_blank" rel="noopener noreferrer">TikTok</a>
          </span>
        </div>
      </div>

      <div class="listSection">
        <div class="overlay">
          <div class="listHeader">
            <h2>ä¸€è¦§ï¼ˆæŠ¼ã—ã¦è¿½åŠ ï¼‰</h2>
            <span class="sub" id="resultCount"></span>
          </div>

          <div class="controlsRow stickyControls">
            <input id="search" type="text" placeholder="Searchï¼ˆåå‰/è‹±å­—/IDï¼‰">
            <button id="toggleBtn" class="togglePill on" type="button">
              <span class="dot"></span>
              <span id="modeText">ç·´ç¿’ç”Ÿ</span>
            </button>
          </div>

          <div class="grid" id="grid"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ ===== -->
  <div id="rankView" class="view">
    <div class="rankPage">
      <div class="rankCard">
        <div class="rankHead">
          <h2>ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h2>
          <div class="rankActions">
            <a id="rankOpenSheet" class="rankLink" href="#" target="_blank" rel="noopener noreferrer">é›†è¨ˆã‚·ãƒ¼ãƒˆ</a>
            <span id="rankUpdated" class="rankMeta">æœªèª­è¾¼</span>
          </div>
        </div>
        <div class="rankBody">

          <!-- â˜… ãƒã‚¤æŠ•ç¥¨ãƒœã‚¿ãƒ³ï¼ˆè¿½åŠ ï¼šãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®ä¸Šï¼‰ -->
          <div class="myBox">
            <div class="myBtns">
              <button id="btnMyToday" class="myBtn" type="button">ğŸ—³ ä»Šæ—¥ã®æŠ•ç¥¨</button>
              <button id="btnMyTotal" class="myBtn" type="button">ğŸ“Š ãƒã‚¤ç´¯è¨ˆ</button>
            </div>

            <div id="panelMyToday" class="myPanel">
              <div class="sub" id="myTodayMeta">æœªä¿å­˜</div>
              <div id="myTodayGrid" class="myGrid" style="margin-top:10px;"></div>
              <div class="myNote">
                â€»åŒã˜ç«¯æœ«ãƒ»åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
                â€»é–²è¦§å±¥æ­´/ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒ»åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã¨æ¶ˆãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
              </div>
            </div>

            <div id="panelMyTotal" class="myPanel">
              <div class="sub" id="myTotalMeta">æœªä¿å­˜</div>

              <div style="margin-top:10px;">
                <div class="sub" style="font-weight:900;">ä¸Šä½3åï¼ˆå›æ•°é †ï¼‰</div>
                <div id="myTop3" class="myTop3" style="margin-top:8px;"></div>
              </div>

             <div style="margin-top:12px;">
  <div id="myTotalGrid" class="myGrid" style="margin-top:8px;"></div>
</div>

              <div class="myNote">
                â€»åŒã˜ç«¯æœ«ãƒ»åŒã˜ãƒ–ãƒ©ã‚¦ã‚¶ã§ã®ã¿è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚<br>
                â€»é–²è¦§å±¥æ­´/ã‚µã‚¤ãƒˆãƒ‡ãƒ¼ã‚¿å‰Šé™¤ãƒ»åˆ¥ãƒ–ãƒ©ã‚¦ã‚¶ã§é–‹ãã¨æ¶ˆãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
              </div>
            </div>
          </div>

          <div class="rankStatusRow">
            <p id="rankStatus" class="rankStatus">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦</p>
            <p class="rankHint">â€»å†™çœŸã‚¿ãƒƒãƒ—ã§profileãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
          </div>

          <div style="overflow:auto;">
            <table class="rankTable">
              <thead>
                <tr>
                  <th class="rankNum">#</th>
                  <th></th>
                  <th class="rankVotes"></th>
                </tr>
              </thead>
              <tbody id="rankTbody"></tbody>
            </table>

            <div id="rankMoreWrap" style="text-align:center; margin-top:12px; display:none;">
              <button id="rankMoreBtn" class="btn" type="button">ã•ã‚‰ã«è¡¨ç¤º</button>
            </div>
          </div>

        </div>
      </div>
      <div class="sub" style="margin-top:10px;">
        â€»ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã¯ã€Œãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã€ã‚’é–‹ã„ãŸæ™‚ã«èª­ã¿è¾¼ã¿ã¾ã™
      </div>
    </div>
  </div>

  <!-- ===== æŠ•ç¥¨å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== -->
  <div id="successModal" class="modalOverlay" aria-hidden="true">
    <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="successTitle">
      <div class="modalHead">
        <p id="successTitle" class="modalTitle">é€ä¿¡å®Œäº†</p>
        <button id="successCloseX" class="modalCloseX" type="button" aria-label="é–‰ã˜ã‚‹">Ã—</button>
      </div>
      <div class="modalBody">
        <p class="modalMsg">æŠ•ç¥¨ã‚’é€ä¿¡ã—ã¾ã—ãŸï¼</p>
        <p class="modalSub">ã“ã®ã¾ã¾Xã®æŠ•ç¨¿ç”»é¢ã¸é£›ã¹ã¾ã™ï¼ˆãƒãƒƒã‚·ãƒ¥ã‚¿ã‚°ä»˜ãï¼‰ã€‚</p>
        <div class="modalActions">
          <a id="successXBtn" class="modalBtn primary" href="#" target="_blank" rel="noopener noreferrer">Xã§ã‚·ã‚§ã‚¢</a>
          <button id="successOkBtn" class="modalBtn" type="button">é–‰ã˜ã‚‹</button>
        </div>
      </div>
    </div>
  </div>

  <!-- â˜… åˆå›è¨ªå•ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆè¿½åŠ ï¼‰ -->
  <div id="welcomeModal" class="welcomeOverlay" aria-hidden="true">
    <div class="welcomeCard" role="dialog" aria-modal="true">
      <div class="welcomeTitle">æ—¥ãƒ—æŠ•ç¥¨ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ä½œæˆã—ãŸã‚ãŒã£ã—ã§ã™ã€‚</div>

      <div class="welcomeText">
  ã‚µã‚¤ãƒˆç¶™ç¶šã¨ã‚„ã‚‹æ°—ã®ãŸã‚ã«<br>
  æ˜¯éTiktokã®ãƒ•ã‚©ãƒ­ãƒ¼ãŠé¡˜ã„ã—ã¾ã™ğŸ¥º<br>
  ä¸‹ã®ãƒœã‚¿ãƒ³ã‹ã‚‰ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«ã«é£›ã¹ã‚‹ã®ã§<br>
  æ˜¯éãƒ•ã‚©ãƒ­ãƒ¼ãŠé¡˜ã„è‡´ã—ã¾ã™â¤ï¸â€ğŸ”¥â¤ï¸â€ğŸ”¥
</div>

      <a class="welcomeBtn"
         href="https://www.tiktok.com/@12agassi"
         target="_blank"
         rel="noopener noreferrer">ã‚ãŒã£ã—ã‚’å¿œæ´ã™ã‚‹â¤ï¸â€ğŸ”¥</a>

      <button class="welcomeClose" type="button" onclick="closeWelcomeModal()">é–‰ã˜ã‚‹</button>
    </div>
  </div>

<script>
/* ======================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°CSV URL
====================== */
const RANKING_CSV_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vTXFpCzSxBGA2HUi1iiTUAgbRTbKXn2StuWI-Og82Wcv1z02sAN5QMizZztFdC8-7He31T-ecZq8cPa/pub?gid=1769988094&single=true&output=csv";
const RANKING_SHOW_TOP = 30;
const RANKING_PAGE_SIZE = 30;

/* ======================
   Googleãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡è¨­å®š
====================== */
const FORM_ACTION = "https://docs.google.com/forms/d/e/1FAIpQLSe0PiR-AbilNCBcoiwWnnhTlEIIniAx09KPKLUP0xIz7xMl5w/formResponse";
const ENTRY_USERKEY = "entry.926427886";
const ENTRY_DATE    = "entry.1759038206";
const ENTRY_IDS     = "entry.1038992501";
const BLOCK_DUPLICATE_PER_DAY = true;

/* ====== ç·´ç¿’ç”Ÿãƒ‡ãƒ¼ã‚¿ ====== */
const traineesOnly = [
  {name:"ã‚¢ãƒ€ãƒ ãƒ»ãƒŠã‚¬ã‚¤(ADAM)", img:"https://i.imgur.com/6QGzvRx.png", id:"adamnagai"},
  {name:"ä¸­ä¸¸ æ™å¯¿(AJU)", img:"https://i.imgur.com/KiZCKos.png", id:"nakamaruaju"},
  {name:"ã‚ªãƒ ãƒ»ã‚¹ã‚¢ãƒ³ã‚«ãƒ¯ãƒ¼ãƒ†ãƒ³(AOM)", img:"https://i.imgur.com/dDIFJSc.png", id:"aomsuungkavathin"},
  {name:"ã‚¢ãƒ¼ãƒãƒ£ãƒ¼ãƒ»ã‚¦ã‚¤(ARCHER)", img:"https://i.imgur.com/5iIerqN.png", id:"archeruy"},
  {name:"ç¯ ãƒ¶è°· æ­©å¤¢(S.AYUMU)", img:"https://i.imgur.com/YJAdh8q.png", id:"shinogayaayumu"},
  {name:"å°æ— åƒæ‚Ÿ(CHISATO)", img:"https://i.imgur.com/Iu0hNBO.png", id:"kobayashichisato"},
  {name:"åŠ è—¤ å¤§æ¨¹ (K.DAIKI)", img:"https://i.imgur.com/4fRk2EB.png", id:"katodaiki"},
  {name:"ã‚«ã‚¯ãƒ»ãƒ‰ãƒ³ãƒŸãƒ³(DONGMIN)", img:"https://i.imgur.com/xZSQqMh.png", id:"kwakdongmin"},
  {name:"æœ«å· ç‘›å¤ª(EITA)", img:"https://i.imgur.com/5aMVSc0.png", id:"suekawaeita"},
  {name:"ä¿é‡Œ ç‘›éƒ½(H.EITO)", img:"https://i.imgur.com/IAhs4ZA.png", id:"horieito"},
  {name:"é‡‘ç”° æ „éƒ½(K.EITO)", img:"https://i.imgur.com/tF7i1du.png", id:"kanedaeito"},
  {name:"æ«»äº• æ¥“çœŸ(FUMA)", img:"https://i.imgur.com/WIWI8Sx.png", id:"sakuraifuma"},
  {name:"å°ç¬ åŸã‚¸ãƒ¥ã‚¼ãƒƒãƒšæ…§(GIUSEPPE)", img:"https://i.imgur.com/2oKn3Ma.jpeg", id:"ogasawaragiuseppekei"},
  {name:"å€‰æ©‹ å¾æ§™(GOTEN)", img:"https://i.imgur.com/hlEjYqR.png", id:"kurahashigoten"},
  {name:"å €å°¾ è–(HIJIRI)", img:"https://i.imgur.com/5Qb5dRJ.png", id:"horiohijiri"},
  {name:"ç‘æ…¶è¦§ å¤ªéƒ½(HIROTO)", img:"https://i.imgur.com/siOPGIr.png", id:"zukeranhiroto"},
  {name:"ãƒ¦ãƒ»ãƒ’ãƒ§ãƒ³ã‚¹ãƒ³(HYEONSEUNG)", img:"https://i.imgur.com/lY3lXLj.png", id:"yoohyeonseung"},
  {name:"å²¡ç”° å½ªå¾(HYUGO)", img:"https://i.imgur.com/zalwc1W.png", id:"okadahyugo"},
  {name:"æŸ³è°· ä¼Šå†´(ISSA)", img:"https://i.imgur.com/gboCNWu.png", id:"yanagiyaissa"},
  {name:"ãƒ¦ãƒ³ãƒ»ã‚¸ã‚§ãƒ¨ãƒ³(JAEYONG)", img:"https://i.imgur.com/1yCImxd.png", id:"yoonjaeyong"},
  {name:"ã‚¸ãƒ¥ã‚¢ãƒ³ãƒ»ã‚¸ã‚§ã‚¤(JAY)", img:"https://i.imgur.com/41jKNZX.png", id:"chuangjay"},
  {name:"ä¸¸å°¾ å°‹ä¸€éƒ(JINICHIRO)", img:"https://i.imgur.com/83azYjx.png", id:"maruojinichiro"},
  {name:"æ²³é‚Š æ™Ÿ(JOE)", img:"https://i.imgur.com/DqUS1o6.png", id:"kawabejoe"},
  {name:"ã‚·ãƒ³ãƒ»ã‚¸ãƒ§ãƒ³ã‚¦ã‚¯(JUNGUK)", img:"https://i.imgur.com/6cwEusK.jpeg", id:"shinjunguk"},
  {name:"é‡‘å®‰ ç´”æ­£(JUNSEI)", img:"https://i.imgur.com/juPhMDR.png", id:"kaneyasujunsei"},
  {name:"å®‡é‡ æµ·å¤¢(KAIMU)", img:"https://i.imgur.com/QVliSyD.png", id:"unokaimu"},
  {name:"å¤šæ¯” å¥è–(KANADE)", img:"https://i.imgur.com/rdSJ6QX.png", id:"tabikanade"},
  {name:"æ¨ªå±± å¥å¤¢(KANAME)", img:"https://i.imgur.com/0brlEw8.png", id:"yokoyamakaname"},
  {name:"é–¢ æ•¬æ¬¡éƒ(KEIJIRO)", img:"https://i.imgur.com/PHlkDUt.png", id:"sekikeijiro"},
  {name:"é«™æ¾ æ•¬ç¥(KEISUKE)", img:"https://i.imgur.com/bs4vfiF.png", id:"takamatsukeisuke"},
  {name:"å°é‡ æ…¶äºº(KEITO)", img:"https://i.imgur.com/glfmRJE.png", id:"onokeito"},
  {name:"è¥¿å±± è³¢äºº(KENTO)", img:"https://i.imgur.com/izEXoBY.png", id:"nishiyamakento"},
  {name:"æ²³åˆ æ™ƒèª (KOSEI)", img:"https://i.imgur.com/E30eGfr.png", id:"kawaikosei"},
  {name:"ç…§äº• åº·ç¥(KOSUKE)", img:"https://i.imgur.com/oDkwdFn.png", id:"teruikosuke"},
  {name:"æµ…é¦™ å­å¤ªéƒ(KOTARO)", img:"https://i.imgur.com/7eJxl8o.png", id:"asakakotaro"},
  {name:"é«™è°· äº¬å¹³(KYOHEI)", img:"https://i.imgur.com/CLU1cPO.png", id:"takayakyohei"},
  {name:"ç”°ä¸­ è’”(MAKI)", img:"https://i.imgur.com/No6Nybr.png", id:"tanakamaki"},
  {name:"å±±æ ¹ æ­¦è”µ(MUSASHI)", img:"https://i.imgur.com/Ou2XuDa.png", id:"yamanemusashi"},
  {name:"åœŸç”° å¤®ä¿®(OSUKE)", img:"https://i.imgur.com/Xs0WjIn.png", id:"tsuchidaosuke"},
  {name:"å €é‡ è“®(H.REN)", img:"https://i.imgur.com/FQEx0JM.png", id:"horinoren"},
  {name:"å°æ¸…æ°´ è“®(KO.REN)", img:"https://i.imgur.com/S8Ij9OZ.png", id:"koshimizuren"},
  {name:"ãƒã‚§ãƒ³ãƒ»ãƒªãƒƒã‚­ãƒ¼(RICKEY)", img:"https://i.imgur.com/DnnZVAT.png", id:"chenrickey"},
  {name:"ç¥å…ƒ ç†ä¸˜(RIKU)", img:"https://i.imgur.com/jwJ9CLd.png", id:"kamimotoriku"},
  {name:"é³©å ´ é™¸äºº(H.RIKUTO)", img:"https://i.imgur.com/JdCFbCb.png", id:"hatobarikuto"},
  {name:"ä»Šæ±Ÿ é™¸æ–—(I.RIKUTO)", img:"https://i.imgur.com/jiZZwJu.png", id:"imaerikuto"},
  {name:"ç”²æ– é™¸ä¹Ÿ(RIKUYA)", img:"https://i.imgur.com/lfiqB2f.png", id:"kairikuya"},
  {name:"å¤§ç€¬ å‡œå’Œ(RINTO)", img:"https://i.imgur.com/OT0UHId.png", id:"ohserinto"},
  {name:"ä¸Šé‡ ç‰å‰(U.RUI)", img:"https://i.imgur.com/36XqMd9.png", id:"uenorui"},
  {name:"é£¯å¡š äº®è³€(RYOGA)", img:"https://i.imgur.com/ExbaI6W.png", id:"iizukaryoga"},
  {name:"çŸ³ç”° äº®å¤ª(RYOTA)", img:"https://i.imgur.com/Ctw95jF.png", id:"ishidaryota"},
  {name:"å²¡æˆ¸ ç«œèŠ½(RYUGA)", img:"https://i.imgur.com/fvfLKZj.png", id:"okadoryuga"},
  {name:"æ‰å±± ç«œå¸(RYUJI)", img:"https://i.imgur.com/NeB980M.png", id:"sugiyamaryuji"},
  {name:"é¦™æœˆ èª å¤ª(SEITA)", img:"https://i.imgur.com/def6F6u.png", id:"katsukiseita"},
  {name:"æ¾¤äº• æ˜Ÿå(SENA)", img:"https://i.imgur.com/Dpzzr9K.png", id:"sawaisena"},
  {name:"ã‚ªãƒ»ã‚·ãƒ³ãƒ˜ãƒ³(SHINHAENG)", img:"https://i.imgur.com/LH673dA.png", id:"ohshinhaeng"},
  {name:"å²©åŸ æ…äºŒ(SHINJI)", img:"https://i.imgur.com/h5rDvjC.png", id:"iwakishinji"},
  {name:"å®®å´ çœŸä½‘(SHINSUKE)", img:"https://i.imgur.com/xJuj9wW.png", id:"miyazakishinsuke"},
  {name:"è¥¿ï¨‘ æŸŠ(N.SHU)", img:"https://i.imgur.com/OZrHFUX.png", id:"nishizakishu"},
  {name:"å±±ä¸‹ æŸŠ(Y.SHU)", img:"https://i.imgur.com/642IX8o.png", id:"yamashitashu"},
  {name:"ãƒ‘ã‚¯ãƒ»ã‚·ãƒ¨ãƒ³(SIYOUNG)", img:"https://i.imgur.com/wSokxJh.png", id:"parksiyoung"},
  {name:"ä½è—¤ ç¢§ç©º (S.SORA)", img:"https://i.imgur.com/yF4WJJB.png", id:"satosora"},
  {name:"æ±é‡ è’¼æ±°(SOTA)", img:"https://i.imgur.com/GvLpwfo.png", id:"tonosota"},
  {name:"è—¤ç‰§ å¤§é›…(F.TAIGA)", img:"https://i.imgur.com/4G2hBRy.png", id:"fujimakitaiga"},
  {name:"æ¾ç”° å¤ªé›…(M.TAIGA)", img:"https://i.imgur.com/tICsJFs.png", id:"matsudataiga"},
  {name:"é‡‘å€‰ æ‹“æœª(TAKUMI)", img:"https://i.imgur.com/O3gluG7.png", id:"kanakuratakumi"},
  {name:"ç†Šéƒ¨ æ‹“æ–—(K.TAKUTO)", img:"https://i.imgur.com/NaQURc7.png", id:"kumabetakuto"},
  {name:"å®®é‡Œ æ‹“åˆ©(M.TAKUTO)", img:"https://i.imgur.com/5B8NMyF.png", id:"miyazatotakuto"},
  {name:"å—å¹³ é”çŸ¢(TATSUYA)", img:"https://i.imgur.com/jHnmGTs.png", id:"minamihiratatsuya"},
  {name:"æ£®äº• è¼(TERU)", img:"https://i.imgur.com/SAo1Rs4.png", id:"moriiteru"},
  {name:"åŒ—æ— å¤©è™(TETORA)", img:"https://i.imgur.com/2gCwqHF.png", id:"kitabayashitetora"},
  {name:"è—¤èŠ³ è¾°å¼¥(TOKIYA)", img:"https://i.imgur.com/9prpjvI.png", id:"fujiyoshitokiya"},
  {name:"å¢—ç”° å€«å¸Œ(TOMOKI)", img:"https://i.imgur.com/4JSh3HD.png", id:"masudatomoki"},
  {name:"æ¿±ç”° æ°¸é (TOWA)", img:"https://i.imgur.com/Yap9beM.png", id:"hamadatowa"},
  {name:"ã‚¢ã‚®ãƒŠãƒ«ãƒ‰ãƒ»ãƒˆãƒªã‚¹ã‚¿ãƒ³ãƒ»ã‚¸ã‚§ãƒ¼ãƒ ã‚¹(TRISTAN)", img:"https://i.imgur.com/wyeHbRo.png", id:"aguinaldotristanjames"},
  {name:"ãƒªãƒ¼ãƒ»ã‚¦ã‚§ã‚¤ã‚¼(WEIZE)", img:"https://i.imgur.com/XNeHaaX.png", id:"liweize"},
  {name:"ãƒ¨ãƒãƒ³ãƒ»ã‚¨ãƒãƒ‹ãƒ¥ã‚¨ãƒ«(YOHAN)", img:"https://i.imgur.com/RTVMTCA.png", id:"yohanemmanuel"},
  {name:"çŸ¢ç”° ä½³æš‰(YOSHIKI)", img:"https://i.imgur.com/MZbSVDq.png", id:"yadayoshiki"},
  {name:"å¾Œè—¤ çµ(YUKI)", img:"https://i.imgur.com/GZTdD57.png", id:"gotoyuki"},
  {name:"å²¡ç”° ä¾‘ç£¨(YUMA)", img:"https://i.imgur.com/3hhNQLj.png", id:"okadayuma"},
  {name:"å®‰éƒ¨ çµè˜­(YURA)", img:"https://i.imgur.com/pbC301p.png", id:"abeyura"},
  {name:"å¤§æ— æ‚ æˆ(O.YUSEI)", img:"https://i.imgur.com/tp1fKqI.png", id:"obayashiyusei"},
  {name:"ä½é‡ ç”±å¾(S.YUSEI)", img:"https://i.imgur.com/fDql5Tu.png", id:"sanoyusei"},
  {name:"æ¿å€‰ æ‚ å¤ª(YUTA)", img:"https://i.imgur.com/j6IlxeD.png", id:"itakurayuta"}
];

const candidates = [
  {name:"æœ¬è˜ æ™ƒ(AKIRA)", img:"https://i.imgur.com/p976l8j.jpeg", id:"honjoakira"},
  {name:"å…å³¶ æ­©å¤¢(K.AYUMU)", img:"https://i.imgur.com/1jtcgbB.png", id:"kojimaayumu"},
  {name:"å¸‚å· å¤§è¼(I.DAIKI)", img:"https://i.imgur.com/72FqxLz.png", id:"ichikawadaiki"},
  {name:"å·æ‘ ç€æ–—(HAKUTO)", img:"https://i.imgur.com/ua7RMig.png", id:"kawamurahakuto"},
  {name:"æ‘æ¾ é¼ç©º(HARUKU)", img:"https://i.imgur.com/3JEtKs6.png", id:"muramatsuharuku"},
  {name:"é«™åŸ æš–äºº(HARUTO)", img:"https://i.imgur.com/qdXIOpr.png", id:"takagiharuto"},
  {name:"å¹³å³¶ è¼(H.HIKARU)", img:"https://i.imgur.com/P5gzRZh.png", id:"hirashimahikaru"},
  {name:"æ«»äº• è¼(S.HIKARU)", img:"https://i.imgur.com/h2fBMUv.png", id:"sakuraihikaru"},
  {name:"ä½å· å¤ªä¸€(HIROKAZU)", img:"https://i.imgur.com/IlVBYXs.png", id:"sagawahirokazu"},
  {name:"ã‚¤ãƒ»ãƒ’ãƒ§ãƒ³ã‚¸ã‚§(HYUNJAE)", img:"https://i.imgur.com/wOhvKDu.png", id:"leehyunjae"},
  {name:"é˜¿éƒ¨ æ¨¹(ITSUKI)", img:"https://i.imgur.com/TaTAc2L.png", id:"abeitsuki"},
  {name:"ã‚¤ãƒ»ã‚¸ãƒ¥ãƒ³ãƒ•ãƒ³(JOONGHOON)", img:"https://i.imgur.com/4utwyOJ.png", id:"leejoonghoon"},
  {name:"ãƒªãƒ¥ã‚¦ãƒ»ã‚«ã‚¤ãƒ(KAICHI)", img:"https://i.imgur.com/FGbdGcI.png", id:"liukaichi"},
  {name:"é»’ï¨‘ è²«æ±°(KANTA)", img:"https://i.imgur.com/j75eoO7.png", id:"kurosakikanta"},
  {name:"é»„ æ•¬çœ(KEISHIN)", img:"https://i.imgur.com/oE7w4D7.png", id:"kokeishin"},
  {name:"é‡¼æŒ å‰æˆ(KINARI)", img:"https://i.imgur.com/GWAtiwS.png", id:"kenmotsukinari"},
  {name:"å°æ¾¤ æ˜‚å¿ƒ(KOSHIN)", img:"https://i.imgur.com/pn0zB7F.png", id:"ozawakoshin"},
  {name:"é’æ²¼ æ˜‚å²æœ—(KOSHIRO)", img:"https://i.imgur.com/MDhTcs8.png", id:"aonumakoshiro"},
  {name:"å°æ— å»£(KOU)", img:"https://i.imgur.com/RAoUIhC.png", id:"kobayashikou"},
  {name:"æ£® æ˜è‚²(MEI)", img:"https://i.imgur.com/eR0BZVs.png", id:"morimei"},
  {name:"ãƒã‚¤ã‚±ãƒ« ãƒŸãƒ³ãƒ»ãƒã‚«ãƒ•ãƒª(MICHAEL MINH)", img:"https://i.imgur.com/6S8BWAA.png", id:"michaelminhmccaffrey"},
  {name:"ãƒ‘ãƒˆãƒªãƒƒã‚¯ ãƒ•ã‚¡ãƒ³ãƒ»ãƒ¬(PATRICK)", img:"https://i.imgur.com/YRvJQYc.png", id:"patrickphanle"},
  {name:"ç¬ åŸ è“®(KA.REN)", img:"https://i.imgur.com/ZLgNm7o.png", id:"kasahararen"},
  {name:"æ±Ÿå£ è“®ç¿”(E.RENTO)", img:"https://i.imgur.com/ewXd8NH.png", id:"eguchirento"},
  {name:"å°æ— è“®ç¿”(K.RENTO)", img:"https://i.imgur.com/t2NbxIU.png", id:"kobayashirento"},
  {name:"è½åˆ åˆ©æ¸©(RIO)", img:"https://i.imgur.com/HdTZUdu.png", id:"ochiairio"},
  {name:"æ°´ä¸Š ç‰å‰(M.RUI)", img:"https://i.imgur.com/DiUA9bw.png", id:"mizugamirui"},
  {name:"å°è°·å†… ç‘ å˜‰(RUKA)", img:"https://i.imgur.com/V2XnsQ6.png", id:"koyauchiruka"},
  {name:"é½Šè—¤ æƒº(SEI)", img:"https://i.imgur.com/9HIRvNd.png", id:"saitosei"},
  {name:"è—¤æœ¬ çœŸæˆ(SHINSEI)", img:"https://i.imgur.com/qTooOuS.png", id:"fujimotoshinsei"},
  {name:"é£¯ç”° æŸŠé¦¬(SHUMA)", img:"https://i.imgur.com/awBBn6j.png", id:"iidashuma"},
  {name:"æ¾ç”° é¢¯å¾(SOGO)", img:"https://i.imgur.com/Y1MQK3k.png", id:"matsudasogo"},
  {name:"é«™æ©‹ ç©ºè‰¯(T.SORA)", img:"https://i.imgur.com/czFpgjm.png", id:"takahashisora"},
  {name:"è¥¿ç”° é¢¯æ¢“(SOSHI)", img:"https://i.imgur.com/51RMIB6.png", id:"nishidasoshi"},
  {name:"å²¡æœ¬ æ‹“å£«(O.TAKUTO)", img:"https://i.imgur.com/TGP6sbe.png", id:"okamototakuto"},
  {name:"å¤§æ¾¤ ä½‘å†´(YUGO)", img:"https://i.imgur.com/5Gg1E1M.png", id:"osawayugo"},
  {name:"è—¤äº• é›„è–(F.YUSEI)", img:"https://i.imgur.com/prsNOtG.png", id:"fujiiyusei"},
  {name:"å²¡æœ¬ ä½‘æ–—(YUTO)", img:"https://i.imgur.com/lzv8Vu5.png", id:"okamotoyuto"}
];

const MAX = 11;

/* =========================
   â˜… è¾é€€è€…IDï¼ˆè¿½åŠ ï¼‰
   - ç·´ç¿’ç”Ÿï¼šä¿é‡Œç‘›éƒ½ï¼ˆhorieitoï¼‰
   - ç·´ç¿’ç”Ÿå€™è£œï¼šæ«»äº•è¼ï¼ˆsakuraihikaruï¼‰
========================= */
const WITHDRAWN_IDS = new Set([
  "horieito",
  "sakuraihikaru"
]);

/* ===== UI elements (vote) ===== */
const toggleBtn = document.getElementById("toggleBtn");
const modeText  = document.getElementById("modeText");
const searchEl  = document.getElementById("search");
const gridEl    = document.getElementById("grid");
const slotsEl   = document.getElementById("slots");
const countEl   = document.getElementById("count");
const voteBtn   = document.getElementById("voteBtn");
const clearBtn  = document.getElementById("clearBtn");
const undoBtn   = document.getElementById("undoBtn");
const resultCountEl = document.getElementById("resultCount");

/* ===== Xã‚·ã‚§ã‚¢ï¼ˆæ—§ï¼‰ ===== */
const shareWrap = document.getElementById("shareWrap");
const xShareBtn = document.getElementById("xShareBtn");

/* ===== UI elements (ranking) ===== */
const rankTbody = document.getElementById("rankTbody");
const rankStatus = document.getElementById("rankStatus");
const rankUpdated = document.getElementById("rankUpdated");
const rankOpenSheet = document.getElementById("rankOpenSheet");

/* ===== ã•ã‚‰ã«è¡¨ç¤º ===== */
const rankMoreWrap = document.getElementById("rankMoreWrap");
const rankMoreBtn  = document.getElementById("rankMoreBtn");

/* ===== view switch ===== */
const btnVote = document.getElementById("btnVote");
const btnRank = document.getElementById("btnRank");
const voteView = document.getElementById("voteView");
const rankView = document.getElementById("rankView");

/* ===== state ===== */
let showCandidates = false;
let selected = [];
let selectedSet = new Set();
let lastActionStack = [];

let rankTimer = null;
let hasLoadedRankOnce = false;

let rankAllData = [];
let rankVisibleCount = RANKING_SHOW_TOP;

/* ===== æŠ•ç¥¨å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ« ===== */
const successModal  = document.getElementById("successModal");
const successXBtn   = document.getElementById("successXBtn");
const successOkBtn  = document.getElementById("successOkBtn");
const successCloseX = document.getElementById("successCloseX");

function openSuccessModal(){
  if(!successModal) return;
  if(successXBtn) successXBtn.href = buildXIntentURL();
  successModal.classList.add("open");
  successModal.setAttribute("aria-hidden","false");
  document.body.style.overflow = "hidden";
}
function closeSuccessModal(){
  if(!successModal) return;
  successModal.classList.remove("open");
  successModal.setAttribute("aria-hidden","true");
  document.body.style.overflow = "";
}
if(successOkBtn) successOkBtn.addEventListener("click", closeSuccessModal);
if(successCloseX) successCloseX.addEventListener("click", closeSuccessModal);
if(successModal){
  successModal.addEventListener("click", (e) => {
    if(e.target === successModal) closeSuccessModal();
  });
}
document.addEventListener("keydown", (e) => {
  if(e.key === "Escape" && successModal && successModal.classList.contains("open")){
    closeSuccessModal();
  }
});

/* ===== XæŠ•ç¨¿ãƒªãƒ³ã‚¯ ===== */
function buildXIntentURL(){
  const text =
`ã‚ãªãŸã®1ç¥¨ãŒæœªæ¥ã‚’å¤‰ãˆã‚‹ğŸ”¥

æ¨ã—ã«ä»Šæ—¥ã‚‚æŠ•ç¥¨å®Œäº†ğŸ—³ï¸âœ¨
ã¾ã ã®äººã¯ä»Šã™ãå‚åŠ ã—ã¦ã­ï¼

#æ—¥ãƒ—æ–°ä¸–ç•Œ #æ—¥ãƒ—æŠ•ç¥¨ãƒ¡ãƒ¼ã‚«ãƒ¼ #PRODUCE101JAPANæ–°ä¸–ç•Œ
â€»éå…¬å¼ãƒ•ã‚¡ãƒ³æŠ•ç¥¨ã§ã™`;
  const url = location.href;
  return "https://twitter.com/intent/tweet?text=" + encodeURIComponent(text) + "&url=" + encodeURIComponent(url);
}

/* ==== æ¤œç´¢å¼·åŒ– ==== */
function normalizeText(s){
  return (s || "")
    .toString()
    .normalize("NFKC")
    .toLowerCase()
    .replace(/[\s\.\-_/()ï¼ˆï¼‰]/g,"");
}
function buildSearchKey(t){
  return [t.name || "", t.id || ""].map(normalizeText).join(" ");
}

const trainees = traineesOnly.map(x => ({...x, group:"trainee", searchKey: buildSearchKey(x)}));
const candis = candidates.map(x => ({...x, group:"candidate", searchKey: buildSearchKey(x)}));
const byId = new Map([...trainees, ...candis].map(x => [x.id, x]));

/* =========================
   â˜… ãƒã‚¤æŠ•ç¥¨ï¼ˆlocalStorageï¼‰è¿½åŠ 
========================= */
const LS_TODAY_PREFIX = "vote_my_today_v1:";     // + YYYY-MM-DD
const LS_COUNTS_KEY   = "vote_my_counts_v1";     // { id: number }
const LS_TOTALSUB_KEY = "vote_my_totalSub_v1";   // number

const btnMyToday  = document.getElementById("btnMyToday");
const btnMyTotal  = document.getElementById("btnMyTotal");
const panelMyToday = document.getElementById("panelMyToday");
const panelMyTotal = document.getElementById("panelMyTotal");
const myTodayMeta = document.getElementById("myTodayMeta");
const myTotalMeta = document.getElementById("myTotalMeta");
const myTodayGrid = document.getElementById("myTodayGrid");
const myTotalGrid = document.getElementById("myTotalGrid");
const myTop3El    = document.getElementById("myTop3");

function safeJSONParse(s, fallback){
  try{ return JSON.parse(s); }catch(_){ return fallback; }
}
function getCounts(){
  return safeJSONParse(localStorage.getItem(LS_COUNTS_KEY) || "{}", {});
}
function setCounts(obj){
  localStorage.setItem(LS_COUNTS_KEY, JSON.stringify(obj || {}));
}
function getTotalSub(){
  return Number(localStorage.getItem(LS_TOTALSUB_KEY) || "0") || 0;
}
function setTotalSub(n){
  localStorage.setItem(LS_TOTALSUB_KEY, String(Number(n || 0)));
}
function getTodayIds(dateStr){
  const key = LS_TODAY_PREFIX + dateStr;
  const v = safeJSONParse(localStorage.getItem(key) || "null", null);
  return Array.isArray(v) ? v : null;
}
function setTodayIds(dateStr, ids){
  const key = LS_TODAY_PREFIX + dateStr;
  localStorage.setItem(key, JSON.stringify(ids || []));
}

function personInfo(id){
  const p = byId.get(id);
  const name = p ? (p.name || id) : id;
  const img = p ? (p.img || "") : "";
  const disp = name.split("(")[0];
  return { id, name, disp, img };
}

function buildMyItemHTML(info, countText, badgeText){
  const safeImg = info.img || "";
  const safeName = (info.disp || info.name || info.id);
  const badge = badgeText ? `<span class="myRankBadge">${badgeText}</span>` : "";
  return `
    <div class="myItem">
      <div style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
        <div style="min-width:0; font-weight:1000; font-size:12px; color:#111; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
          ${safeName}
        </div>
        ${badge}
      </div>
      <div class="myThumb" style="margin-top:8px;">
        ${safeImg ? `<img src="${safeImg}" alt="">` : ``}
      </div>
      <div class="myCount">${countText || ""}</div>
    </div>
  `;
}

function refreshMyToday(){
  const date = todayTokyo();
  const ids = getTodayIds(date);

  if(!myTodayGrid || !myTodayMeta) return;

  if(!ids || ids.length === 0){
    myTodayMeta.textContent = `ä»Šæ—¥(${date})ã®æŠ•ç¥¨ã¯ã¾ã ä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“`;
    myTodayGrid.innerHTML = "";
    return;
  }

  myTodayMeta.textContent = `ä»Šæ—¥(${date})ã®æŠ•ç¥¨ï¼š${ids.length}äºº`;
  myTodayGrid.innerHTML = ids.map(id => {
    const info = personInfo(id);
    return buildMyItemHTML(info, "", "");
  }).join("");
}

function refreshMyTotal(){
  const counts = getCounts();
  const totalSub = getTotalSub();

  if(!myTotalGrid || !myTotalMeta || !myTop3El) return;

  const entries = Object.entries(counts)
    .map(([id, c]) => ({ id, count: Number(c)||0 }))
    .filter(x => x.count > 0);

  myTotalMeta.textContent = totalSub > 0
    ? `ã“ã‚Œã¾ã§ã®æŠ•ç¥¨å›æ•°ï¼š${totalSub}å›ï¼ˆ= 11äººÃ—${totalSub}å›åˆ†ã‚«ã‚¦ãƒ³ãƒˆï¼‰`
    : "ç´¯è¨ˆã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“";

  if(entries.length === 0){
    myTop3El.innerHTML = "";
    myTotalGrid.innerHTML = "";
    return;
  }

  // ä¸Šä½3åã ã‘ã€Œå›æ•°é †ã«ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã€
  const topSorted = [...entries].sort((a,b) => b.count - a.count || a.id.localeCompare(b.id));
  const top3 = topSorted.slice(0,3);

  myTop3El.innerHTML = top3.map((x, i) => {
    const info = personInfo(x.id);
    return buildMyItemHTML(info, `${x.count}å›`, String(i+1));
  }).join("");

  // ãã®ä»–ï¼ˆå®‰å®šã®ãŸã‚åå‰é †ï¼‰
  const rest = topSorted.slice(3).map(x => ({
    ...x,
    disp: personInfo(x.id).disp
  })).sort((a,b) => (a.disp||a.id).localeCompare(b.disp||b.id, "ja"));

  myTotalGrid.innerHTML = rest.map(x => {
    const info = personInfo(x.id);
    return buildMyItemHTML(info, `${x.count}å›`, "");
  }).join("");
}

function closeMyPanels(){
  if(btnMyToday) btnMyToday.classList.remove("active");
  if(btnMyTotal) btnMyTotal.classList.remove("active");
  if(panelMyToday) panelMyToday.classList.remove("active");
  if(panelMyTotal) panelMyTotal.classList.remove("active");
}
function togglePanel(which){
  if(which === "today"){
    const willOpen = !(panelMyToday && panelMyToday.classList.contains("active"));
    closeMyPanels();
    if(willOpen){
      if(btnMyToday) btnMyToday.classList.add("active");
      if(panelMyToday) panelMyToday.classList.add("active");
      refreshMyToday();
    }
  } else {
    const willOpen = !(panelMyTotal && panelMyTotal.classList.contains("active"));
    closeMyPanels();
    if(willOpen){
      if(btnMyTotal) btnMyTotal.classList.add("active");
      if(panelMyTotal) panelMyTotal.classList.add("active");
      refreshMyTotal();
    }
  }
}
if(btnMyToday) btnMyToday.addEventListener("click", () => togglePanel("today"));
if(btnMyTotal) btnMyTotal.addEventListener("click", () => togglePanel("total"));

function saveMyVote(ids, dateStr){
  // ä»Šæ—¥ã®11äººã‚’ä¿å­˜ï¼ˆä¸Šæ›¸ãï¼‰
  setTodayIds(dateStr, ids.slice(0, MAX));

  // ç´¯è¨ˆï¼ˆå„IDã‚’+1ï¼‰
  const counts = getCounts();
  for(const id of ids.slice(0, MAX)){
    counts[id] = (Number(counts[id]) || 0) + 1;
  }
  setCounts(counts);

  // æŠ•ç¥¨å›æ•°ï¼ˆé€ä¿¡æˆåŠŸã—ãŸå›æ•°ï¼‰
  setTotalSub(getTotalSub() + 1);
}

/* ==== scrollä½ç½®ä¿æŒ ==== */
function preserveScroll(fn){
  const y = window.scrollY;
  fn();
  requestAnimationFrame(() => window.scrollTo(0, y));
}

/* ==== è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ ==== */
function currentList(){ return showCandidates ? candis : trainees; }
function setModeUI(){
  modeText.textContent = showCandidates ? "ç·´ç¿’ç”Ÿå€™è£œ" : "ç·´ç¿’ç”Ÿ";
  toggleBtn.classList.toggle("on", !showCandidates);
}

/* ==== ä¸Šã®11æ  ==== */
function renderSlots(){
  slotsEl.innerHTML = "";
  for(let i=0;i<MAX;i++){
    const id = selected[i];
    const slot = document.createElement("div");
    slot.className = "slot" + (id ? " filled" : "");
    if(id) slot.setAttribute("data-id", id);

    if(id){
      const t = byId.get(id);
      slot.innerHTML = `<img src="${t?.img || ""}" alt="">`;
      slot.title = "ã‚¿ãƒƒãƒ—ã§å‰Šé™¤";
    } else {
      slot.textContent = "+";
    }
    slotsEl.appendChild(slot);
  }
}
slotsEl.addEventListener("click", (e) => {
  const slot = e.target.closest(".slot.filled");
  if(!slot) return;
  const id = slot.getAttribute("data-id");
  if(!id) return;
  removeSelected(id);
});

/* ==== ä¸€è¦§ ==== */
function renderGrid(){
  const qRaw = searchEl.value.trim();
  const q = normalizeText(qRaw);

  const list = currentList().filter(t => {
    if(!q) return true;
    const rawHit =
      (t.name || "").toLowerCase().includes(qRaw.toLowerCase()) ||
      (t.id || "").toLowerCase().includes(qRaw.toLowerCase());
    const keyHit = (t.searchKey || "").includes(q);
    return rawHit || keyHit;
  });

  resultCountEl.textContent = `${list.length}ä»¶`;
  gridEl.innerHTML = "";

  for(const t of list){
    const picked = selectedSet.has(t.id);
    const withdrawn = WITHDRAWN_IDS.has(t.id);

    const card = document.createElement("div");
    card.className = "card"
      + (picked ? " picked" : "")
      + (withdrawn ? " withdrawn" : "");
    card.setAttribute("data-id", t.id);

    card.innerHTML = `
      <div class="avatar">
        <img src="${t.img}" alt="">
        <a class="profileBtn"
           href="https://produce101.jp/profile/detail/?id=${encodeURIComponent(t.id)}"
           target="_blank" rel="noopener noreferrer"
           data-profile-link="1">profile</a>
      </div>
      <div class="info">
        <div class="name">${t.name}</div>
        <div class="meta">${showCandidates ? "ç·´ç¿’ç”Ÿå€™è£œ" : "ç·´ç¿’ç”Ÿ"}</div>
      </div>
    `;
    gridEl.appendChild(card);
  }
}
gridEl.addEventListener("click", (e) => {
  if (e.target.closest('[data-profile-link="1"]')) return;
  const card = e.target.closest(".card");
  if(!card) return;
  const id = card.getAttribute("data-id");
  if(!id) return;

  preserveScroll(() => {
    if(selectedSet.has(id)) removeSelected(id);
    else addSelected(id);
  });
});

/* ==== é¸æŠå‡¦ç† ==== */
function addSelected(id){
  /* â˜… è¾é€€è€…ã¯é¸æŠä¸å¯ï¼ˆè¿½åŠ ï¼‰ */
  if(WITHDRAWN_IDS.has(id)) return;

  if(selectedSet.has(id)) return;
  if(selected.length >= MAX){
    alert(`æœ€å¤§${MAX}äººã¾ã§ã§ã™`);
    return;
  }
  selected.push(id);
  selectedSet.add(id);
  lastActionStack.push({type:"add", id});
  updateAll();
}
function removeSelected(id){
  if(!selectedSet.has(id)) return;
  selected = selected.filter(x => x !== id);
  selectedSet.delete(id);
  lastActionStack.push({type:"remove", id});
  updateAll();
}
function undo(){
  const last = lastActionStack.pop();
  if(!last) return;
  if(last.type === "add"){
    selected = selected.filter(x => x !== last.id);
    selectedSet.delete(last.id);
  } else {
    if(selected.length < MAX && !selectedSet.has(last.id)){
      selected.push(last.id);
      selectedSet.add(last.id);
    }
  }
  updateAll();
}
function clearAll(){
  selected = [];
  selectedSet.clear();
  lastActionStack = [];
  updateAll();
}

/* ==== æ—¥ä»˜ï¼ˆTokyoï¼‰ ==== */
function todayTokyo(){
  return new Date().toLocaleDateString("en-CA", { timeZone:"Asia/Tokyo" });
}

/* ==== userKey ==== */
function getOrCreateUserKey(){
  const keyName = "vote_userKey_v1";
  let k = localStorage.getItem(keyName);
  if(!k){
    const rand = (crypto?.randomUUID?.() || (Math.random().toString(16).slice(2) + Date.now().toString(16)));
    k = "u_" + rand.slice(0, 12);
    localStorage.setItem(keyName, k);
  }
  return k;
}

/* ==== äºŒé‡é€ä¿¡ãƒ–ãƒ­ãƒƒã‚¯ ==== */
function lastVoteToken(){
  return localStorage.getItem("vote_lastToken_v1") || "";
}
function setLastVoteToken(token){
  localStorage.setItem("vote_lastToken_v1", token);
}

/* ==== é€ä¿¡ ==== */
async function submitToGoogleForm(){
  if(selected.length !== MAX){
    alert(`11äººé¸ã‚“ã§ã‹ã‚‰æŠ•ç¥¨ã—ã¦ãã ã•ã„`);
    return;
  }

  const userKey = getOrCreateUserKey();
  const date = todayTokyo();
  const token = `${userKey}|${date}`;

  if(BLOCK_DUPLICATE_PER_DAY && lastVoteToken() === token){
    alert("ã“ã®ç«¯æœ«ã§ã¯ä»Šæ—¥ã™ã§ã«æŠ•ç¥¨æ¸ˆã¿ã§ã™ã€‚");
    return;
  }

  const idsStr = JSON.stringify(selected.slice(0, MAX));

  const fd = new FormData();
  fd.append(ENTRY_USERKEY, userKey);
  fd.append(ENTRY_DATE, date);
  fd.append(ENTRY_IDS, idsStr);

  try{
    voteBtn.disabled = true;
    voteBtn.textContent = "é€ä¿¡ä¸­â€¦";

    await fetch(FORM_ACTION, { method: "POST", mode: "no-cors", body: fd });

    if(BLOCK_DUPLICATE_PER_DAY) setLastVoteToken(token);

    // â˜… é€ä¿¡æˆåŠŸã—ãŸã€Œã“ã®11äººã€ã‚’ä¿å­˜ï¼ˆä»Šæ—¥ï¼‹ç´¯è¨ˆï¼‰
    saveMyVote(selected.slice(0, MAX), date);

    // â˜… æŠ•ç¥¨å®Œäº†ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    openSuccessModal();

    // æ—§ã‚·ã‚§ã‚¢æ¬„ã¯ä½¿ã‚ãªã„ï¼ˆä½¿ã†ãªã‚‰ display:flex ã«å¤‰ãˆã‚‹ï¼‰
    if(shareWrap && xShareBtn){
      xShareBtn.href = buildXIntentURL();
      shareWrap.style.display = "none";
    }

    clearAll();

    // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”»é¢ã§è¦‹ã¦ã‚‹ãªã‚‰ã€ãƒã‚¤è¡¨ç¤ºã‚‚æ›´æ–°ã§ãã‚‹
    if(rankView.classList.contains("active")){
      refreshMyToday();
      refreshMyTotal();
      fetchRankingCSV();
    }
  }catch(err){
    console.error(err);
    alert("é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nãƒãƒƒãƒˆæ¥ç¶šã‚„ãƒ–ãƒ©ã‚¦ã‚¶è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
  }finally{
    updateAll();
  }
}

/* ==== æ›´æ–° ==== */
function updateAll(){
  countEl.textContent = String(selected.length);
  voteBtn.disabled = selected.length !== MAX;
  voteBtn.textContent = (selected.length === MAX) ? "æŠ•ç¥¨ã™ã‚‹" : `ã‚ã¨ ${MAX - selected.length} äºº`;
  renderSlots();
  renderGrid();
}

/* ==== UIã‚¤ãƒ™ãƒ³ãƒˆ ==== */
toggleBtn.addEventListener("click", () => {
  preserveScroll(() => {
    showCandidates = !showCandidates;
    setModeUI();
    renderGrid();
  });
});
searchEl.addEventListener("input", () => preserveScroll(() => renderGrid()));
undoBtn.addEventListener("click", () => preserveScroll(() => undo()));
clearBtn.addEventListener("click", () => {
  if(!confirm("é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ")) return;
  preserveScroll(() => clearAll());
});
voteBtn.addEventListener("click", () => submitToGoogleForm());

/* ======================
   ãƒ©ãƒ³ã‚­ãƒ³ã‚°CSVèª­ã¿è¾¼ã¿
====================== */
rankOpenSheet.href = RANKING_CSV_URL;

function parseCSV(text){
  const rows = [];
  let row = [];
  let cur = "";
  let inQuotes = false;

  for(let i=0;i<text.length;i++){
    const ch = text[i];
    const next = text[i+1];

    if(ch === '"'){
      if(inQuotes && next === '"'){ cur += '"'; i++; }
      else inQuotes = !inQuotes;
      continue;
    }
    if(!inQuotes && ch === ","){ row.push(cur); cur=""; continue; }
    if(!inQuotes && (ch === "\n" || ch === "\r")){
      if(ch === "\r" && next === "\n") i++;
      row.push(cur); rows.push(row);
      row=[]; cur="";
      continue;
    }
    cur += ch;
  }
  if(cur.length || row.length){ row.push(cur); rows.push(row); }
  return rows;
}
function nowTokyoTime(){
  return new Date().toLocaleString("ja-JP", { timeZone:"Asia/Tokyo" });
}
function buildRankingLink(id){
  return `https://produce101.jp/profile/detail/?id=${encodeURIComponent(id)}`;
}

function renderRanking(){
  const list = rankAllData.slice(0, rankVisibleCount);
  const frag = document.createDocumentFragment();

  let prevVotes = null;
  let prevRank = 0;

  list.forEach((x, i) => {
    const tr = document.createElement("tr");

    let shownRank;
    if (prevVotes !== null && x.votes === prevVotes) {
      shownRank = prevRank;
    } else {
      shownRank = i + 1;
      prevRank = shownRank;
      prevVotes = x.votes;
    }

    const person = byId.get(x.id);
    const imgUrl = person ? person.img : "";
    const dispName = person ? person.name.split("(")[0] : x.id;

    tr.innerHTML = `
      <td class="rankNum">${shownRank}</td>
      <td>
        <div class="rankLeft">
          <a class="rankThumbLink"
             href="${buildRankingLink(x.id)}"
             target="_blank" rel="noopener noreferrer"
             aria-label="profile">
            <img class="rankThumb"
                 src="${imgUrl}"
                 alt=""
                 onerror="this.style.display='none'">
          </a>
          <div class="rankName">${dispName}</div>
        </div>
      </td>
      <td class="rankVotes">${x.votes}ç¥¨</td>
    `;
    frag.appendChild(tr);
  });

  rankTbody.innerHTML = "";
  rankTbody.appendChild(frag);

  const total = rankAllData.length;
  const shown = Math.min(rankVisibleCount, total);

  rankStatus.textContent = total <= 0 ? "ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“" : `è¡¨ç¤ºä¸­: ${shown} / å…¨${total}ä»¶`;

  if(rankMoreWrap && rankMoreBtn){
    if(shown < total){
      rankMoreWrap.style.display = "block";
      const left = total - shown;
      const add = Math.min(RANKING_PAGE_SIZE, left);
      rankMoreBtn.textContent = `ã•ã‚‰ã«è¡¨ç¤ºï¼ˆ+${add}ï¼‰`;
    } else {
      rankMoreWrap.style.display = "none";
    }
  }
}

async function fetchRankingCSV(){
  try{
    rankStatus.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’èª­ã¿è¾¼ã¿ä¸­â€¦";
    rankUpdated.textContent = "èª­ã¿è¾¼ã¿ä¸­â€¦";
    rankTbody.innerHTML = "";
    if(rankMoreWrap) rankMoreWrap.style.display = "none";

    rankVisibleCount = RANKING_SHOW_TOP;

    const url = RANKING_CSV_URL + "&_ts=" + Date.now();
    const res = await fetch(url, { method:"GET", cache:"no-store" });
    if(!res.ok) throw new Error("HTTP " + res.status);
    const text = await res.text();

    const rows = parseCSV(text)
      .map(r => r.map(x => (x ?? "").toString().trim()))
      .filter(r => r.some(x => x !== ""));

    if(rows.length < 2) throw new Error("CSVãŒç©ºã£ã½");

    const header = rows[0].map(h => h.toLowerCase());
    const idxId = header.indexOf("id");
    const idxVotes = header.indexOf("votes");
    const idxRank = header.indexOf("rank");

    if(idxId === -1 || idxVotes === -1) throw new Error("CSVåˆ—åãŒé•ã†ï¼ˆid/votesç„¡ã—ï¼‰");

    const data = rows.slice(1).map(r => ({
      id: r[idxId] || "",
      votes: Number((r[idxVotes] || "0").replace(/[^\d\-]/g,"")) || 0,
      rank: idxRank !== -1 ? (Number((r[idxRank] || "").replace(/[^\d\-]/g,"")) || null) : null
    })).filter(x => x.id);

    data.sort((a,b) => {
      if(a.rank != null && b.rank != null) return a.rank - b.rank;
      if(b.votes !== a.votes) return b.votes - a.votes;
      return a.id.localeCompare(b.id);
    });

    rankAllData = data;
    renderRanking();

    rankUpdated.textContent = `æ›´æ–°: ${nowTokyoTime()}`;
    hasLoadedRankOnce = true;

  }catch(err){
    console.error(err);
    rankStatus.textContent = "ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—â€¦ï¼ˆå…¬é–‹è¨­å®š/URL/ãƒãƒƒãƒˆã‚’ç¢ºèªã—ã¦ã­ï¼‰";
    rankUpdated.textContent = "æ›´æ–°: å¤±æ•—";
    if(rankMoreWrap) rankMoreWrap.style.display = "none";
  }
}

if(rankMoreBtn){
  rankMoreBtn.addEventListener("click", () => {
    const total = rankAllData.length;
    if(total <= 0) return;
    rankVisibleCount = Math.min(rankVisibleCount + RANKING_PAGE_SIZE, total);
    renderRanking();
  });
}

/* ======================
   ç”»é¢åˆ‡æ›¿ï¼ˆæŠ•ç¥¨ â‡„ ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼‰
====================== */
function showVote(){
  voteView.classList.add("active");
  rankView.classList.remove("active");
  btnVote.classList.add("active");
  btnRank.classList.remove("active");

  if(rankTimer){ clearInterval(rankTimer); rankTimer = null; }
  window.scrollTo(0,0);
}
function showRank(){
  rankView.classList.add("active");
  voteView.classList.remove("active");
  btnRank.classList.add("active");
  btnVote.classList.remove("active");

  // â˜… ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã«å…¥ã£ãŸã‚‰ã€ãƒã‚¤æŠ•ç¥¨ã®è¡¨ç¤ºã‚‚æœ€æ–°åŒ–ï¼ˆãƒ‘ãƒãƒ«ã¯é–‰ã˜ãŸã¾ã¾ï¼‰
  refreshMyToday();
  refreshMyTotal();

  fetchRankingCSV();

  if(rankTimer){ clearInterval(rankTimer); }
  rankTimer = setInterval(fetchRankingCSV, 30000);

  window.scrollTo(0,0);
}

btnVote.addEventListener("click", showVote);
btnRank.addEventListener("click", showRank);

/* åˆæœŸæç”» */
setModeUI();
renderSlots();
renderGrid();
updateAll();

/* =========================
   â˜… åˆå›è¨ªå•ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆè¿½åŠ ï¼‰
========================= */
function closeWelcomeModal(){
  const modal = document.getElementById("welcomeModal");
  if(modal){
    modal.style.display = "none";
    modal.setAttribute("aria-hidden","true");
    localStorage.setItem("welcomeShown_v1","1");
  }
}
window.addEventListener("load", () => {
  const shown = localStorage.getItem("welcomeShown_v1");
  const modal = document.getElementById("welcomeModal");
  if(modal && !shown){
    modal.style.display = "flex";
    modal.setAttribute("aria-hidden","false");
  }
});
</script>
    <div style="text-align:center; font-size:12px; opacity:0.6; margin-top:60px;">
  <a href="./about.html" style="text-decoration:none; color:inherit;">About</a> |
  <a href="./privacy.html" style="text-decoration:none; color:inherit;">Privacy</a> |
  <a href="./contact.html" style="text-decoration:none; color:inherit;">Contact</a>
</div>

</body>
</html>
